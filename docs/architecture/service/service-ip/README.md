# service-ip

IP 地区服务，检测用户地理位置并智能选择镜像源。

## 🧅 第一层：在 Service 中的位置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          burncloud-service                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │                        服务层                                       │    │
│   │                                                                     │    │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │    │
│   │   │ service-monitor │  │ service-user    │  │★service-ip      │    │    │
│   │   │                 │  │                 │  │                 │    │    │
│   │   │ CPU 监控        │  │ 注册登录        │  │ 地区检测        │    │    │
│   │   │ 内存监控        │  │ JWT Token       │  │ 镜像选择        │    │    │
│   │   │ 磁盘监控        │  │ 密码哈希        │  │ 配置缓存        │    │    │
│   │   └─────────────────┘  └─────────────────┘  └─────────────────┘    │    │
│   │                                                                     │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

service-ip 的职责:
├── 用户地区检测
├── 地区结果缓存
└── 智能镜像源选择
```

## 🧅 第二层：文件结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       service-ip 文件结构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  crates/service/crates/service-ip/                                           │
│  │                                                                           │
│  ├── Cargo.toml           # 依赖配置                                        │
│  └── src/                                                                    │
│      └── lib.rs           # IP 地区服务实现                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第三层：lib.rs 详解 - 数据结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据结构定义                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  /// 地区枚举                                                                │
│  pub enum Region {                                                           │
│      CN,        // 中国大陆                                                  │
│      WORLD,     // 其他地区                                                  │
│  }                                                                           │
│                                                                              │
│  impl Region {                                                               │
│      pub fn as_str(&self) -> &str {                                          │
│          match self {                                                        │
│              Region::CN => "CN",                                             │
│              Region::WORLD => "WORLD",                                       │
│          }                                                                   │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
│  // 支持从字符串解析                                                         │
│  impl FromStr for Region {                                                   │
│      fn from_str(s: &str) -> Result<Self, ()> {                              │
│          match s {                                                           │
│              "CN" => Ok(Region::CN),                                         │
│              "WORLD" => Ok(Region::WORLD),                                   │
│              _ => Err(()),                                                   │
│          }                                                                   │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│  /// IP API 响应结构 (ip-api.com)                                            │
│  struct IpApiResponse {                                                      │
│      country_code: String,          // 国家代码 (如 "CN", "US")             │
│  }                                                                           │
│                                                                              │
│  /// IP API 响应结构 (ipinfo.io)                                             │
│  struct IpInfoResponse {                                                     │
│      country: String,               // 国家代码                             │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第四层：核心功能

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          核心功能                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  /// 获取用户地区（带缓存）                                                  │
│  pub async fn get_location() -> Result<String, Box<dyn Error>>               │
│                                                                              │
│  流程:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  1. 查询 SettingService 缓存 (key: "location")                      │   │
│  │     ├── 存在 → 直接返回缓存值                                        │   │
│  │     └── 不存在 → 继续查询                                            │   │
│  │                                                                      │   │
│  │  2. 调用 get_user_region() 获取地区                                  │   │
│  │                                                                      │   │
│  │  3. 保存到缓存                                                       │   │
│  │     SettingService::set("location", region)                         │   │
│  │                                                                      │   │
│  │  4. 返回地区字符串 ("CN" 或 "WORLD")                                 │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│  /// 获取用户地区（实际查询）                                                │
│  pub async fn get_user_region() -> Result<Region, Box<dyn Error>>            │
│                                                                              │
│  流程:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  1. 尝试第一个 API: ip-api.com                                       │   │
│  │     GET http://ip-api.com/json/                                     │   │
│  │     ├── 成功 → 返回 Region                                          │   │
│  │     └── 失败 → 继续下一个 API                                       │   │
│  │                                                                      │   │
│  │  2. 尝试备用 API: ipinfo.io                                          │   │
│  │     GET https://ipinfo.io/json                                      │   │
│  │     └── 返回 Region                                                 │   │
│  │                                                                      │   │
│  │  地区判断:                                                           │   │
│  │  ├── country_code == "CN" → Region::CN                              │   │
│  │  └── 其他 → Region::WORLD                                           │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第五层：API 详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          IP API 详解                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  主 API: ip-api.com                                                          │
│  ────────────────────                                                        │
│  GET http://ip-api.com/json/                                                 │
│                                                                              │
│  响应示例:                                                                   │
│  {                                                                           │
│    "countryCode": "CN",                                                      │
│    "country": "China",                                                       │
│    "region": "BJ",                                                           │
│    "city": "Beijing",                                                        │
│    "isp": "China Unicom"                                                     │
│  }                                                                           │
│                                                                              │
│  特点: 免费版有速率限制 (45次/分钟)                                          │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│  备用 API: ipinfo.io                                                         │
│  ────────────────────                                                        │
│  GET https://ipinfo.io/json                                                  │
│                                                                              │
│  响应示例:                                                                   │
│  {                                                                           │
│    "country": "US",                                                          │
│    "region": "California",                                                   │
│    "city": "San Francisco",                                                  │
│    "ip": "8.8.8.8"                                                           │
│  }                                                                           │
│                                                                              │
│  特点: 免费版有月度限制 (1000次/月)                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第六层：使用场景

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          使用场景                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  service-models 使用:                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  // 获取 HuggingFace Host                                           │   │
│  │  let location = get_location().await?;  // "CN" 或 "WORLD"          │   │
│  │                                                                      │   │
│  │  let host = match location.as_str() {                               │   │
│  │      "CN" => "https://hf-mirror.com/",    // 国内镜像               │   │
│  │      _ => "https://huggingface.co/",      // 官方                   │   │
│  │  };                                                                  │   │
│  │                                                                      │   │
│  │  // 首次运行时:                                                      │   │
│  │  // 1. 检测地区 (API 查询)                                           │   │
│  │  // 2. 缓存结果到数据库                                              │   │
│  │  // 3. 后续直接使用缓存                                              │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  优点:                                                                       │
│  ├── 自动选择最快的镜像源                                                   │
│  ├── 首次检测后缓存，避免重复请求                                           │
│  └── 国内用户自动使用 hf-mirror.com 加速                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 依赖关系

```
service-ip
├── burncloud-service-setting
│   └── SettingService (缓存)
└── external
    ├── reqwest          # HTTP 请求
    └── serde            # JSON 反序列化
```
