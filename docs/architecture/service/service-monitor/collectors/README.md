# collectors

数据收集器模块，提供 CPU、内存、磁盘等系统指标的跨平台收集功能。

## 🧅 第一层：在 service-monitor 中的位置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          service-monitor                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │                        监控模块                                     │    │
│   │                                                                     │    │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │    │
│   │   │★collectors      │  │ service.rs      │  │ types.rs        │    │    │
│   │   │                 │  │                 │  │                 │    │    │
│   │   │ CpuCollector    │  │ 服务封装        │  │ 数据类型        │    │    │
│   │   │ MemoryCollector │  │ 状态缓存        │  │ 错误定义        │    │    │
│   │   │ DiskCollector   │  │ 自动更新        │  │ 格式化工具      │    │    │
│   │   └─────────────────┘  └─────────────────┘  └─────────────────┘    │    │
│   │                                                                     │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

collectors 的职责:
├── CPU 使用率收集 (跨平台)
├── 内存使用情况收集 (跨平台)
├── 磁盘空间监控 (跨平台)
└── 平台差异屏蔽
```

## 🧅 第二层：文件结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       collectors 文件结构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  crates/service/crates/service-monitor/src/collectors/                       │
│  │                                                                           │
│  ├── mod.rs              # 模块入口，重导出                                  │
│  ├── cpu.rs              # CPU 收集器                                       │
│  ├── memory.rs           # 内存收集器                                       │
│  └── disk.rs             # 磁盘收集器                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第三层：cpu.rs - CPU 收集器

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          cpu.rs - CPU 收集器                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  /// CPU 数据收集器                                                          │
│  pub struct CpuCollector {                                                   │
│      _last_update: Instant,            // 上次更新时间                      │
│      update_interval: Duration,        // 更新间隔                          │
│      #[cfg(unix)]                                                            │
│      last_cpu_times: Option<CpuTimes>, // 上次 CPU 时间 (计算使用率)        │
│  }                                                                           │
│                                                                              │
│  /// CPU 时间 (内部结构)                                                     │
│  struct CpuTimes {                                                           │
│      idle: u64,    // 空闲时间                                               │
│      total: u64,   // 总时间                                                 │
│  }                                                                           │
│                                                                              │
│  核心方法:                                                                   │
│  /// 收集 CPU 信息                                                           │
│  pub async fn collect(&mut self) -> Result<CpuInfo, MonitorError>            │
│                                                                              │
│  使用率计算:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  1. 读取当前 CPU 时间                                                │   │
│  │  2. 计算 delta_total = current.total - last.total                   │   │
│  │  3. 计算 delta_idle = current.idle - last.idle                      │   │
│  │  4. usage = 100% - (delta_idle / delta_total * 100%)                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  跨平台实现:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Windows:                                                            │   │
│  │  ├── GetSystemInfo() 获取核心数                                     │   │
│  │  ├── 注册表读取 CPU 品牌和频率                                      │   │
│  │  └── 简化版返回固定使用率 (需完善)                                  │   │
│  │                                                                      │   │
│  │  Unix:                                                               │   │
│  │  ├── /proc/stat 读取 CPU 时间                                       │   │
│  │  ├── /proc/cpuinfo 读取核心数和品牌                                 │   │
│  │  └── 通过两次采样计算使用率                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第四层：memory.rs - 内存收集器

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        memory.rs - 内存收集器                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  /// 内存数据收集器                                                          │
│  pub struct MemoryCollector;                                                 │
│                                                                              │
│  核心方法:                                                                   │
│  /// 收集内存信息                                                            │
│  pub async fn collect(&self) -> Result<MemoryInfo, MonitorError>             │
│                                                                              │
│  /// 获取详细内存信息 (包含 swap)                                            │
│  pub async fn get_detailed_info(&self) -> Result<DetailedMemoryInfo>         │
│                                                                              │
│  跨平台实现:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Windows:                                                            │   │
│  │  └── GlobalMemoryStatusEx() 获取内存状态                            │   │
│  │      ├── ullTotalPhys (总物理内存)                                  │   │
│  │      └── ullAvailPhys (可用物理内存)                                │   │
│  │                                                                      │   │
│  │  Unix:                                                               │   │
│  │  └── /proc/meminfo 读取内存信息                                     │   │
│  │      ├── MemTotal (总内存)                                          │   │
│  │      ├── MemAvailable 或 (MemFree + Buffers + Cached)               │   │
│  │      └── SwapTotal / SwapFree (交换区)                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  详细内存信息:                                                               │
│  pub struct DetailedMemoryInfo {                                             │
│      pub memory: MemoryInfo,        // 基本内存信息                         │
│      pub swap_total: u64,           // 交换区总大小                         │
│      pub swap_used: u64,            // 交换区已使用                         │
│      pub swap_free: u64,            // 交换区可用                           │
│      pub swap_usage_percent: f32,   // 交换区使用率                         │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第五层：disk.rs - 磁盘收集器

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         disk.rs - 磁盘收集器                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  /// 磁盘数据收集器                                                          │
│  pub struct DiskCollector;                                                   │
│                                                                              │
│  核心方法:                                                                   │
│  /// 收集所有磁盘信息                                                        │
│  pub async fn collect_all(&self) -> Result<Vec<DiskInfo>, MonitorError>      │
│                                                                              │
│  /// 收集主磁盘信息                                                          │
│  pub async fn collect_main_disk(&self) -> Result<Option<DiskInfo>>           │
│                                                                              │
│  跨平台实现:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Windows:                                                            │   │
│  │  ├── GetDiskFreeSpaceExW() 获取磁盘空间                             │   │
│  │  └── 默认只检查 C:\ 盘                                              │   │
│  │                                                                      │   │
│  │  Unix:                                                               │   │
│  │  ├── /proc/mounts 读取挂载点列表                                    │   │
│  │  ├── statvfs() 系统调用获取空间信息                                 │   │
│  │  └── 过滤本地文件系统 (ext4, xfs, btrfs, zfs, ...)                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  文件系统过滤 (Unix):                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  本地文件系统:                                                       │   │
│  │  ext2, ext3, ext4, xfs, btrfs, zfs, reiserfs, jfs,                 │   │
│  │  ntfs, vfat, exfat, hfs, apfs                                       │   │
│  │                                                                      │   │
│  │  排除的挂载点:                                                       │   │
│  │  /proc, /sys, /dev, /run, /tmp, /var/tmp                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第六层：数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据流                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  收集流程 (在 service.rs 中):                                                │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                                                                        │  │
│  │  SystemMonitorService::collect_fresh_metrics()                         │  │
│  │         │                                                              │  │
│  │         ▼                                                              │  │
│  │  tokio::join!( ─────────────────────────────────────────────────────┐ │  │
│  │      │                                                               │ │  │
│  │      │  cpu_collector.lock().collect()     → CpuInfo                │ │  │
│  │      │       │                                                       │ │  │
│  │      │       ├── Windows: winapi                                     │ │  │
│  │      │       └── Unix: /proc/stat                                    │ │  │
│  │      │                                                               │ │  │
│  │      │  memory_collector.collect()         → MemoryInfo             │ │  │
│  │      │       │                                                       │ │  │
│  │      │       ├── Windows: GlobalMemoryStatusEx                       │ │  │
│  │      │       └── Unix: /proc/meminfo                                 │ │  │
│  │      │                                                               │ │  │
│  │      │  disk_collector.collect_all()       → Vec<DiskInfo>          │ │  │
│  │      │       │                                                       │ │  │
│  │      │       ├── Windows: GetDiskFreeSpaceExW                        │ │  │
│  │      │       └── Unix: /proc/mounts + statvfs                        │ │  │
│  │      │                                                               │ │  │
│  │  )  ◄────────────────────────────────────────────────────────────────┘ │  │
│  │         │                                                              │  │
│  │         ▼                                                              │  │
│  │  SystemMetrics::new(cpu, memory, disks)                               │  │
│  │         │                                                              │  │
│  │         ▼                                                              │  │
│  │  更新缓存 (cached_metrics)                                            │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 依赖关系

```
collectors
├── types.rs
│   └── CpuInfo, MemoryInfo, DiskInfo, MonitorError
└── external
    ├── tokio            # 异步运行时
    ├── libc             # Unix 系统调用
    └── winapi           # Windows API
```
