# service-inference

æœ¬åœ°æ¨ç†æœåŠ¡ç®¡ç†æ¨¡å—ï¼Œè´Ÿè´£ llama-server ç­‰æ¨ç†åç«¯çš„è¿›ç¨‹ç®¡ç†ã€‚

## ğŸ§… ç¬¬ä¸€å±‚ï¼šåœ¨ Service ä¸­çš„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          burncloud-service                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        æœåŠ¡å±‚                                       â”‚    â”‚
â”‚   â”‚                                                                     â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚   â”‚   â”‚ service-monitor â”‚  â”‚ service-user    â”‚  â”‚â˜…service-inferenceâ”‚   â”‚    â”‚
â”‚   â”‚   â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚    â”‚    â”‚
â”‚   â”‚   â”‚ CPU ç›‘æ§        â”‚  â”‚ æ³¨å†Œç™»å½•        â”‚  â”‚ æ¨ç†è¿›ç¨‹ç®¡ç†    â”‚    â”‚    â”‚
â”‚   â”‚   â”‚ å†…å­˜ç›‘æ§        â”‚  â”‚ JWT Token       â”‚  â”‚ æœ¬åœ°æ¨¡å‹æœåŠ¡    â”‚    â”‚    â”‚
â”‚   â”‚   â”‚ ç£ç›˜ç›‘æ§        â”‚  â”‚ å¯†ç å“ˆå¸Œ        â”‚  â”‚ Router æ³¨å†Œ     â”‚    â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚   â”‚                                                                     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

service-inference çš„èŒè´£:
â”œâ”€â”€ æ¨ç†è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ è¿›ç¨‹çŠ¶æ€ç›‘æ§
â”œâ”€â”€ è‡ªåŠ¨æ³¨å†Œåˆ° Router
â””â”€â”€ æ¨ç†é…ç½®ç®¡ç†
```

## ğŸ§… ç¬¬äºŒå±‚ï¼šæ–‡ä»¶ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       service-inference æ–‡ä»¶ç»“æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  crates/service/crates/service-inference/                                    â”‚
â”‚  â”‚                                                                           â”‚
â”‚  â”œâ”€â”€ Cargo.toml           # ä¾èµ–é…ç½®                                        â”‚
â”‚  â””â”€â”€ src/                                                                    â”‚
â”‚      â””â”€â”€ lib.rs           # æ¨ç†æœåŠ¡å®ç°                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬ä¸‰å±‚ï¼šlib.rs è¯¦è§£ - æ•°æ®ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ•°æ®ç»“æ„å®šä¹‰                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  /// æ¨ç†å®ä¾‹çŠ¶æ€                                                            â”‚
â”‚  pub enum InstanceStatus {                                                   â”‚
â”‚      Stopped,                       // å·²åœæ­¢                               â”‚
â”‚      Starting,                      // å¯åŠ¨ä¸­                               â”‚
â”‚      Running,                       // è¿è¡Œä¸­                               â”‚
â”‚      Failed(String),                // å¤±è´¥ (å¸¦é”™è¯¯ä¿¡æ¯)                    â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                              â”‚
â”‚  /// æ¨ç†å®ä¾‹é…ç½®                                                            â”‚
â”‚  pub struct InferenceConfig {                                                â”‚
â”‚      pub model_id: String,          // æ¨¡å‹ ID                              â”‚
â”‚      pub file_path: String,         // GGUF æ–‡ä»¶ç»å¯¹è·¯å¾„                    â”‚
â”‚      pub port: u16,                 // ç›‘å¬ç«¯å£                             â”‚
â”‚      pub context_size: u32,         // ä¸Šä¸‹æ–‡å¤§å°                           â”‚
â”‚      pub gpu_layers: i32,           // GPU å±‚æ•° (-1 = å…¨éƒ¨)                â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                              â”‚
â”‚  /// æ¨ç†æœåŠ¡ç®¡ç†å™¨                                                          â”‚
â”‚  pub struct InferenceService {                                               â”‚
â”‚      processes: Arc<Mutex<HashMap<String, Child>>>,  // è¿›ç¨‹å¥æŸ„            â”‚
â”‚      statuses: Arc<Mutex<HashMap<String, InstanceStatus>>>, // çŠ¶æ€        â”‚
â”‚      db: Database,                  // æ•°æ®åº“è¿æ¥                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬å››å±‚ï¼šæ ¸å¿ƒåŠŸèƒ½ - å¯åŠ¨æ¨ç†å®ä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å¯åŠ¨æ¨ç†å®ä¾‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub async fn start_instance(&self, config: InferenceConfig) -> Result<()>   â”‚
â”‚                                                                              â”‚
â”‚  æµç¨‹:                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1. æ£€æŸ¥æ˜¯å¦å·²åœ¨è¿è¡Œ                                                 â”‚   â”‚
â”‚  â”‚     å¦‚æœ status == Running æˆ– Starting â†’ ç›´æ¥è¿”å›                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  2. æ›´æ–°çŠ¶æ€ä¸º Starting                                              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  3. æŸ¥æ‰¾ llama-server å¯æ‰§è¡Œæ–‡ä»¶                                     â”‚   â”‚
â”‚  â”‚     â”œâ”€â”€ ç¯å¢ƒå˜é‡ BURNCLOUD_LLAMA_BIN                                â”‚   â”‚
â”‚  â”‚     â”œâ”€â”€ ./bin/llama-server.exe                                      â”‚   â”‚
â”‚  â”‚     â””â”€â”€ PATH ä¸­çš„ llama-server                                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  4. æ„å»ºå¯åŠ¨å‘½ä»¤                                                     â”‚   â”‚
â”‚  â”‚     llama-server -m <model_path> --port <port>                      â”‚   â”‚
â”‚  â”‚                   -c <ctx> -ngl <gpu_layers> --nobrowser            â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  5. å¯åŠ¨å­è¿›ç¨‹                                                       â”‚   â”‚
â”‚  â”‚     Command::spawn() â†’ Child                                        â”‚   â”‚
â”‚  â”‚     â”œâ”€â”€ æˆåŠŸ â†’ ä¿å­˜è¿›ç¨‹å¥æŸ„ï¼Œæ›´æ–°çŠ¶æ€ä¸º Running                     â”‚   â”‚
â”‚  â”‚     â””â”€â”€ å¤±è´¥ â†’ æ›´æ–°çŠ¶æ€ä¸º Failed(err_msg)                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  6. æ³¨å†Œåˆ° Router                                                    â”‚   â”‚
â”‚  â”‚     register_upstream(&config)                                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬äº”å±‚ï¼šæ ¸å¿ƒåŠŸèƒ½ - åœæ­¢æ¨ç†å®ä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          åœæ­¢æ¨ç†å®ä¾‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub async fn stop_instance(&self, model_id: &str) -> Result<()>             â”‚
â”‚                                                                              â”‚
â”‚  æµç¨‹:                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1. ä»è¿›ç¨‹è¡¨ä¸­å–å‡ºè¿›ç¨‹å¥æŸ„                                           â”‚   â”‚
â”‚  â”‚     processes.lock().remove(model_id)                               â”‚   â”‚
â”‚  â”‚     â””â”€â”€ ä¸å­˜åœ¨ â†’ ç›´æ¥è¿”å›                                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  2. ç»ˆæ­¢è¿›ç¨‹                                                         â”‚   â”‚
â”‚  â”‚     child.kill().await                                              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  3. æ›´æ–°çŠ¶æ€ä¸º Stopped                                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  4. ä» Router æ³¨é”€                                                   â”‚   â”‚
â”‚  â”‚     unregister_upstream(model_id)                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬å…­å±‚ï¼šRouter æ³¨å†Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Router æ³¨å†Œæœºåˆ¶                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  /// æ³¨å†Œ Upstream åˆ° Router æ•°æ®åº“                                          â”‚
â”‚  async fn register_upstream(&self, config: &InferenceConfig) -> Result<()>   â”‚
â”‚                                                                              â”‚
â”‚  æ³¨å†Œæµç¨‹:                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1. æ„å»º Upstream ID                                                 â”‚   â”‚
â”‚  â”‚     upstream_id = "local-{model_id}"                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  2. æ„å»º Base URL                                                    â”‚   â”‚
â”‚  â”‚     base_url = "http://127.0.0.1:{port}"                            â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  3. åˆ›å»º DbUpstream å¯¹è±¡                                             â”‚   â”‚
â”‚  â”‚     DbUpstream {                                                    â”‚   â”‚
â”‚  â”‚       id: "local-llama-2-7b",                                       â”‚   â”‚
â”‚  â”‚       name: "Local: llama-2-7b",                                    â”‚   â”‚
â”‚  â”‚       base_url: "http://127.0.0.1:8080",                            â”‚   â”‚
â”‚  â”‚       api_key: "",                    // æ— éœ€é‰´æƒ                   â”‚   â”‚
â”‚  â”‚       match_path: "/v1/chat/completions", // OpenAI å…¼å®¹            â”‚   â”‚
â”‚  â”‚       auth_type: "Bearer",            // å ä½                       â”‚   â”‚
â”‚  â”‚       priority: 100,                  // æœ¬åœ°æ¨¡å‹ä¼˜å…ˆçº§é«˜           â”‚   â”‚
â”‚  â”‚       protocol: "openai",             // OpenAI åè®®                â”‚   â”‚
â”‚  â”‚       ...                                                           â”‚   â”‚
â”‚  â”‚     }                                                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  4. å…ˆåˆ é™¤æ—§è®°å½•ï¼Œå†æ’å…¥æ–°è®°å½• (Upsert)                              â”‚   â”‚
â”‚  â”‚     RouterDatabase::delete_upstream(&upstream_id)                   â”‚   â”‚
â”‚  â”‚     RouterDatabase::create_upstream(&upstream)                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  æ•ˆæœ:                                                                       â”‚
â”‚  â”œâ”€â”€ Router è‡ªåŠ¨å‘ç°æœ¬åœ°æ¨ç†æœåŠ¡                                            â”‚
â”‚  â”œâ”€â”€ ä¼˜å…ˆçº§ 100 ä½¿æœ¬åœ°æ¨¡å‹ä¼˜å…ˆè¢«ä½¿ç”¨                                        â”‚
â”‚  â””â”€â”€ åœæ­¢å®ä¾‹æ—¶è‡ªåŠ¨ä» Router ç§»é™¤                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬ä¸ƒå±‚ï¼šçŠ¶æ€ç›‘æ§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          çŠ¶æ€ç›‘æ§                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  /// è·å–å®ä¾‹çŠ¶æ€                                                            â”‚
â”‚  pub async fn get_status(&self, model_id: &str) -> InstanceStatus            â”‚
â”‚                                                                              â”‚
â”‚  çŠ¶æ€è½¬æ¢:                                                                   â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚
â”‚   â”‚ Stopped â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                          â”‚                   â”‚
â”‚        â”‚                                               â”‚                   â”‚
â”‚        â”‚ start_instance()                              â”‚                   â”‚
â”‚        â–¼                                               â”‚                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     spawn() æˆåŠŸ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                   â”‚
â”‚   â”‚ Starting â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Running â”‚        â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚                   â”‚
â”‚        â”‚                                 â”‚             â”‚                   â”‚
â”‚        â”‚ spawn() å¤±è´¥                    â”‚ stop_instance()                 â”‚
â”‚        â–¼                                 â”‚             â”‚                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚             â”‚                   â”‚
â”‚   â”‚ Failed  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚                   â”‚
â”‚        â”‚                                               â”‚                   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                              â”‚
â”‚  å­˜å‚¨æ–¹å¼:                                                                   â”‚
â”‚  statuses: Arc<Mutex<HashMap<String, InstanceStatus>>>                       â”‚
â”‚  â”œâ”€â”€ çº¿ç¨‹å®‰å…¨ (Mutex)                                                       â”‚
â”‚  â”œâ”€â”€ å¯å…±äº« (Arc)                                                           â”‚
â”‚  â””â”€â”€ æŒ‰æ¨¡å‹ ID æŸ¥è¯¢                                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ä¾èµ–å…³ç³»

```
service-inference
â”œâ”€â”€ burncloud-database
â”‚   â””â”€â”€ Database
â”œâ”€â”€ burncloud-database-router
â”‚   â””â”€â”€ RouterDatabase
â””â”€â”€ external
    â”œâ”€â”€ tokio            # å¼‚æ­¥è¿è¡Œæ—¶ + è¿›ç¨‹ç®¡ç†
    â”œâ”€â”€ anyhow           # é”™è¯¯å¤„ç†
    â””â”€â”€ serde            # åºåˆ—åŒ–
```
