# burncloud-router

æ•°æ®å¹³é¢ (Data Plane)ï¼Œæ ¸å¿ƒç½‘å…³ç»„ä»¶ã€‚

## ğŸ§… ç¬¬ä¸€å±‚ï¼šRouter åœ¨ç³»ç»Ÿä¸­çš„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Router åœ¨ç³»ç»Ÿä¸­çš„ä½ç½®                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚     â”‚   Client    â”‚   SDK / Browser / CLI                                   â”‚
â”‚     â”‚   Request   â”‚   POST /v1/chat/completions                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   Authorization: Bearer sk-xxx                          â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â–¼                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚                      burncloud-server                            â”‚    â”‚
â”‚     â”‚                      (Port 3000)                                 â”‚    â”‚
â”‚     â”‚                                                                 â”‚    â”‚
â”‚     â”‚   åˆ¤æ–­è·¯å¾„ â†’ /v1/* è½¬å‘ç»™ Router                                â”‚    â”‚
â”‚     â”‚                                                                 â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚                                           â”‚
â”‚                                  â–¼                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚                                                                â”‚    â”‚
â”‚     â”‚                   ğŸ”„ burncloud-router                          â”‚    â”‚
â”‚     â”‚                   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                          â”‚    â”‚
â”‚     â”‚                                                                â”‚    â”‚
â”‚     â”‚   èŒè´£:                                                        â”‚    â”‚
â”‚     â”‚   â”œâ”€â”€ ğŸ” è®¤è¯: éªŒè¯ Bearer Token                              â”‚    â”‚
â”‚     â”‚   â”œâ”€â”€ ğŸ’° é…é¢: æ£€æŸ¥ç”¨æˆ·ä½™é¢                                    â”‚    â”‚
â”‚     â”‚   â”œâ”€â”€ ğŸš¦ é™æµ: é˜²æ­¢è¯·æ±‚è¿‡è½½                                    â”‚    â”‚
â”‚     â”‚   â”œâ”€â”€ ğŸ”€ è·¯ç”±: æ¨¡å‹å â†’ ä¸Šæ¸¸é€šé“                               â”‚    â”‚
â”‚     â”‚   â”œâ”€â”€ ğŸ”Œ é€‚é…: åè®®è½¬æ¢ (OpenAI/Claude/Gemini)                 â”‚    â”‚
â”‚     â”‚   â”œâ”€â”€ âš¡ é€ä¼ : æµå¼å“åº”é›¶å»¶è¿Ÿ                                  â”‚    â”‚
â”‚     â”‚   â”œâ”€â”€ ğŸ’µ è®¡è´¹: Token è®¡è´¹                                      â”‚    â”‚
â”‚     â”‚   â””â”€â”€ ğŸ”¥ ç†”æ–­: æ•…éšœéš”ç¦»                                        â”‚    â”‚
â”‚     â”‚                                                                â”‚    â”‚
â”‚     â”‚   æ ¸å¿ƒåŸåˆ™: "Don't Touch the Body"                             â”‚    â”‚
â”‚     â”‚   è·¯ç”±å™¨æ˜¯æ™ºèƒ½ç®¡é“ï¼Œä¸è§£æ/ä¿®æ”¹è¯·æ±‚ä½“                           â”‚    â”‚
â”‚     â”‚                                                                â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚                                           â”‚
â”‚                                  â–¼                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚     â”‚  Upstream   â”‚   OpenAI / Anthropic / Google / Azure                   â”‚
â”‚     â”‚  Provider   â”‚                                                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬äºŒå±‚ï¼šRouter æ•´ä½“é€»è¾‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Router æ•´ä½“é€»è¾‘                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                        â”‚   è¯·æ±‚è¿›å…¥      â”‚                                  â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                 â”‚                                            â”‚
â”‚                                 â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                       proxy_handler (æ ¸å¿ƒå¤„ç†å‡½æ•°)                     â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚   â”‚  Auth   â”‚ â†’ â”‚  Quota  â”‚ â†’ â”‚  Rate   â”‚ â†’ â”‚  Model  â”‚ â†’ â”‚ Proxy â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  Check  â”‚   â”‚  Check  â”‚   â”‚  Limit  â”‚   â”‚  Route  â”‚   â”‚ Logic â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                               â”‚     â”‚  â”‚
â”‚  â”‚   Token éªŒè¯    ä½™é¢æ£€æŸ¥      é™æµæ£€æŸ¥      æ¨¡å‹è·¯ç”±      ä¸Šæ¸¸è½¬å‘ â”‚  â”‚
â”‚  â”‚   â†“ 401        â†“ 402        â†“ 429         â†’ Channel    â†’ å“åº”   â”‚  â”‚
â”‚  â”‚                                                               â”‚     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚                       â”‚                       â”‚                   â”‚
â”‚         â–¼                       â–¼                       â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   æ ¸å¿ƒç»„ä»¶     â”‚    â”‚   åè®®é€‚é…     â”‚    â”‚   è´Ÿè½½å‡è¡¡     â”‚            â”‚
â”‚  â”‚                â”‚    â”‚                â”‚    â”‚                â”‚            â”‚
â”‚  â”‚ â€¢ AppState     â”‚    â”‚ â€¢ adaptor/     â”‚    â”‚ â€¢ balancer/    â”‚            â”‚
â”‚  â”‚ â€¢ limiter      â”‚    â”‚   - factory    â”‚    â”‚   - mod        â”‚            â”‚
â”‚  â”‚ â€¢ circuit_     â”‚    â”‚   - dynamic    â”‚    â”‚                â”‚            â”‚
â”‚  â”‚   breaker      â”‚    â”‚   - detector   â”‚    â”‚ RoundRobin     â”‚            â”‚
â”‚  â”‚ â€¢ channel_     â”‚    â”‚   - claude     â”‚    â”‚                â”‚            â”‚
â”‚  â”‚   state        â”‚    â”‚   - gemini     â”‚    â”‚                â”‚            â”‚
â”‚  â”‚ â€¢ model_router â”‚    â”‚   - vertex     â”‚    â”‚                â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬ä¸‰å±‚ï¼šAppState ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AppState ç»“æ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  struct AppState                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ client: Client                          # HTTP å®¢æˆ·ç«¯      â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # ç”¨äºè½¬å‘è¯·æ±‚      â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ config: Arc<RwLock<RouterConfig>>     # è·¯ç”±é…ç½®          â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # upstreams/groups â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ db: Arc<Database>                       # æ•°æ®åº“è¿æ¥       â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # TokenéªŒè¯/æ—¥å¿—   â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ balancer: Arc<RoundRobinBalancer>      # è´Ÿè½½å‡è¡¡å™¨        â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # è½®è¯¢é€‰æ‹©æˆå‘˜      â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ limiter: Arc<RateLimiter>              # é™æµå™¨            â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # ä»¤ç‰Œæ¡¶ç®—æ³•        â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ circuit_breaker: Arc<CircuitBreaker>   # ç†”æ–­å™¨            â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # æ•…éšœéš”ç¦»          â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ log_tx: mpsc::Sender<DbRouterLog>     # æ—¥å¿—é€šé“           â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # å¼‚æ­¥å†™å…¥          â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ model_router: Arc<ModelRouter>         # æ¨¡å‹è·¯ç”±å™¨        â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # modelâ†’channel    â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ channel_state: Arc<ChannelStateTracker> # é€šé“çŠ¶æ€è¿½è¸ª     â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # å¥åº·ç›‘æ§          â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ adaptor_factory: Arc<DynamicAdaptorFactory> # åè®®é€‚é…å·¥å‚ â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # åŠ¨æ€é€‚é…          â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ api_version_detector                   # API ç‰ˆæœ¬æ£€æµ‹å™¨    â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                         # åºŸå¼ƒç‰ˆæœ¬æ›´æ–°      â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬å››å±‚ï¼šæ¨¡å—ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ¨¡å—ç»“æ„                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  crates/router/src/                                                          â”‚
â”‚  â”‚                                                                           â”‚
â”‚  â”‚  lib.rs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”‚  â”‚                                                                        â”‚
â”‚  â”‚  â”‚  å…¥å£æ–‡ä»¶ï¼ŒåŒ…å«:                                                       â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ æ¨¡å—å£°æ˜                                                         â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ AppState å®šä¹‰                                                    â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ create_router_app()                                              â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ proxy_handler()                                                  â”‚
â”‚  â”‚  â”‚  â””â”€â”€ proxy_logic()                                                    â”‚
â”‚  â”‚  â”‚                                                                        â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  â”‚  â”‚                                                                       â”‚
â”‚  â”‚  â”œâ”€â–º æ ¸å¿ƒæ¨¡å—                                                            â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ billing.rs        # ğŸ’µ è®¡è´¹è®¡ç®—                                 â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ token_counter.rs  # ğŸ”¢ Token è®¡æ•°å™¨                             â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ stream_parser.rs  # ğŸ“Š æµå¼å“åº”è§£æ                              â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ channel_state.rs  # ğŸ“¡ é€šé“çŠ¶æ€è¿½è¸ª                              â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ circuit_breaker.rs# ğŸ”¥ ç†”æ–­å™¨                                   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ adaptive_limit.rs # ğŸ¯ è‡ªé€‚åº”é™æµ                               â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ model_router.rs   # ğŸ”€ æ¨¡å‹è·¯ç”±å™¨                               â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ limiter.rs        # ğŸš¦ åŸºç¡€é™æµå™¨                               â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ config.rs         # âš™ï¸ é…ç½®ç±»å‹                                 â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ passthrough.rs    # âš¡ é€ä¼ æ¨¡å¼                                 â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ response_parser.rs# ğŸ“ å“åº”è§£æ                                 â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ price_sync.rs     # ğŸ’° ä»·æ ¼åŒæ­¥                                 â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ pricing_loader.rs # ğŸ“‹ ä»·æ ¼åŠ è½½                                 â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ exchange_rate.rs  # ğŸ’± æ±‡ç‡ç®¡ç†                                 â”‚
â”‚  â”‚  â”‚   â””â”€â”€ notification.rs   # ğŸ”” é€šçŸ¥æœåŠ¡                                 â”‚
â”‚  â”‚  â”‚                                                                       â”‚
â”‚  â”‚  â”œâ”€â–º å­ç›®å½•æ¨¡å—                                                          â”‚
â”‚  â”‚  â”‚   â”‚                                                                   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ adaptor/          # ğŸ”Œ åè®®é€‚é…å™¨                               â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ mod.rs        #   Adaptor trait                             â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ factory.rs    #   åŠ¨æ€é€‚é…å™¨å·¥å‚                             â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ dynamic.rs    #   è¿è¡Œæ—¶é…ç½®é€‚é…                             â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ detector.rs   #   API ç‰ˆæœ¬æ£€æµ‹                              â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ mapping.rs    #   JSON å­—æ®µæ˜ å°„                             â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ claude.rs     #   Anthropic é€‚é…                            â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ gemini.rs     #   Google Gemini é€‚é…                        â”‚
â”‚  â”‚  â”‚   â”‚   â””â”€â”€ vertex.rs     #   Vertex AI é€‚é…                            â”‚
â”‚  â”‚  â”‚   â”‚                                                                   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ balancer/        # âš–ï¸ è´Ÿè½½å‡è¡¡                                  â”‚
â”‚  â”‚  â”‚       â””â”€â”€ mod.rs        #   RoundRobinBalancer                         â”‚
â”‚  â”‚  â”‚                                                                       â”‚
â”‚  â”‚  â””â”€â–º å­ Crate                                                            â”‚
â”‚  â”‚      crates/router/crates/                                               â”‚
â”‚  â”‚      â””â”€â”€ router-aws/      # â˜ï¸ AWS SigV4 ç­¾å                            â”‚
â”‚  â”‚          â””â”€â”€ lib.rs        #   AWS è®¤è¯                                   â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬äº”å±‚ï¼šè¯·æ±‚å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯·æ±‚å¤„ç†æµç¨‹ (proxy_handler)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚    è¯·æ±‚è¿›å…¥                                                                  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 1: æå– Bearer Token                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  headers.get("authorization")                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  strip_prefix("Bearer ") â†’ user_token                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ç¼ºå°‘ Token â†’ 401 Unauthorized                                  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 2: éªŒè¯ Token                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  RouterDatabase::validate_token_and_get_info(&db, &token)       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  è¿”å›: (user_id, group, quota_limit, used_quota)                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”œâ”€ Expired â†’ 401 token_expired                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â””â”€ Invalid â†’ 401 invalid_token                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 3: é…é¢æ£€æŸ¥                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  if used_quota >= quota_limit                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â†’ 402 Insufficient quota                                   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 4: é™æµæ£€æŸ¥                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  limiter.check(&user_id, 1.0)                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â””â”€ å¤±è´¥ â†’ 429 Too Many Requests                       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 5: è§£æè¯·æ±‚ä½“                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  body.collect() â†’ body_bytes                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  serde_json::from_slice â†’ æå– model_name                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  æ£€æµ‹ batch/priority è¯·æ±‚ç±»å‹                                   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 6: è°ƒç”¨ proxy_logic()                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  è¿”å›: (response, upstream_id, status_code)                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  è¯¦è§ä¸‹æ–¹ "proxy_logic è¯¦è§£"                                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 7: è®¡è´¹è®¡ç®—                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  if prompt_tokens > 0 || completion_tokens > 0                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      PriceModel::get(model, currency, region)                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      è®¡è´¹ä¼˜å…ˆçº§:                                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      1. cache > 0       â†’ calculate_cache_cost()                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      2. has_tiered      â†’ calculate_tiered_cost()               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      3. is_priority     â†’ calculate_priority_cost()             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      4. is_batch        â†’ calculate_batch_cost()                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      5. é»˜è®¤            â†’ standard_cost()                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 8: å¼‚æ­¥æ—¥å¿— & æ‰£è´¹                                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  log_tx.send(DbRouterLog { ... })                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  tokio::spawn(async {                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      RouterDatabase::deduct_quota(&db, user_id, token, cost)    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  })                                                             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚    è¿”å› Response                                                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬å…­å±‚ï¼šproxy_logic è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          proxy_logic è¯¦è§£                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚    è¿›å…¥ proxy_logic()                                                        â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1ï¸âƒ£ æ¨¡å‹è·¯ç”± (ä¼˜å…ˆ)                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  ä» body æå– model åç§°                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  model_router.route_with_state(group, model, channel_state)     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”œâ”€ æˆåŠŸ â†’ candidates.push(channel)                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â””â”€ å¤±è´¥ â†’ å°è¯•è·¯å¾„è·¯ç”±                                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2ï¸âƒ£ è·¯å¾„è·¯ç”± (å›é€€)                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  if candidates.is_empty()                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      config.find_route(path)                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”œâ”€ Upstream â†’ candidates.push(u)                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â””â”€ Group â†’ æŒ‰æƒé‡æ·»åŠ æˆå‘˜                              â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3ï¸âƒ£ éå†å€™é€‰é€šé“                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  for upstream in candidates:                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â–º ç†”æ–­æ£€æŸ¥                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   circuit_breaker.allow_request(&upstream.id)            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   ä¸å…è®¸ â†’ è·³è¿‡æ­¤é€šé“                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â–º é€ä¼ æ£€æµ‹                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   should_passthrough(path, body, channel_type)           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   Passthrough â†’ ç›´æ¥è½¬å‘ï¼Œä¸è½¬æ¢                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â–º åè®®é€‚é…                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   adaptor = adaptor_factory.get_adaptor(channel_type)    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   adaptor.convert_request(&req)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â–º è½¬å‘è¯·æ±‚                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   client.request(url).headers(...).send()                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â–º å“åº”å¤„ç†                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   æˆåŠŸ â†’ è®°å½•æˆåŠŸï¼Œè¿”å›å“åº”                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚   å¤±è´¥ â†’ è®°å½•å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â””â”€â–º æµå¼å¤„ç†                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚          stream_parser.parse_chunk()                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚          token_counter.add_tokens()                             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4ï¸âƒ£ æ‰€æœ‰é€šé“å¤±è´¥                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  return 502 Bad Gateway                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  "All upstreams failed. Last error: {last_error}"               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬ä¸ƒå±‚ï¼šæ ¸å¿ƒæ¨¡å—è¯¦è§£

### billing.rs - è®¡è´¹æ¨¡å—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            billing.rs                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ç»“æ„ä½“:                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AdvancedPricing                                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ input_price: i64            # è¾“å…¥ä»·æ ¼ (çº³ç¾å…ƒ/ç™¾ä¸‡Token)         â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ output_price: i64           # è¾“å‡ºä»·æ ¼                            â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ cache_read_price            # ç¼“å­˜è¯»å–ä»·æ ¼ (10% æ ‡å‡†)              â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ cache_creation_price        # ç¼“å­˜åˆ›å»ºä»·æ ¼ (25% æ ‡å‡†)              â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ batch_input/output_price    # æ‰¹é‡ä»·æ ¼ (50% æ ‡å‡†)                  â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ priority_input/output_price # ä¼˜å…ˆçº§ä»·æ ¼ (170% æ ‡å‡†)               â”‚  â”‚
â”‚  â”‚  â””â”€â”€ audio_input_price           # éŸ³é¢‘ä»·æ ¼                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  è®¡è´¹å‡½æ•°:                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  calculate_tiered_cost_full()   # åˆ†æ®µç´¯åŠ                              â”‚  â”‚
â”‚  â”‚  â”‚   ç”¨äº Qwen ç­‰æŒ‰ä¸Šä¸‹æ–‡é•¿åº¦åˆ†æ®µè®¡è´¹çš„æ¨¡å‹                           â”‚  â”‚
â”‚  â”‚  â”‚   ä¾‹: 0-128K: $0.5, 128K-1M: $1.0, 1M+: $2.0                     â”‚  â”‚
â”‚  â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  calculate_cache_cost()         # ç¼“å­˜è®¡è´¹                             â”‚  â”‚
â”‚  â”‚  â”‚   cache_read: 10% æ ‡å‡†ä»·æ ¼                                        â”‚  â”‚
â”‚  â”‚  â”‚   cache_creation: 25% æ ‡å‡†ä»·æ ¼                                    â”‚  â”‚
â”‚  â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  calculate_batch_cost()         # æ‰¹é‡è®¡è´¹ (50%)                       â”‚  â”‚
â”‚  â”‚  calculate_priority_cost()      # ä¼˜å…ˆçº§è®¡è´¹ (170%)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  è®¡è´¹ä¼˜å…ˆçº§:                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. cache_read > 0 || cache_creation > 0                              â”‚  â”‚
â”‚  â”‚     â†’ calculate_cache_cost()                                          â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  2. has_tiered_pricing                                                â”‚  â”‚
â”‚  â”‚     â†’ calculate_tiered_cost_full()                                    â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  3. is_priority_request                                               â”‚  â”‚
â”‚  â”‚     â†’ calculate_priority_cost()                                       â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  4. is_batch_request                                                  â”‚  â”‚
â”‚  â”‚     â†’ calculate_batch_cost()                                          â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  5. é»˜è®¤                                                              â”‚  â”‚
â”‚  â”‚     â†’ æ ‡å‡†è®¡è´¹                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### circuit_breaker.rs - ç†”æ–­å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        circuit_breaker.rs                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  çŠ¶æ€æœº:                                                                     â”‚
â”‚                                                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         å¤±è´¥è¾¾åˆ°é˜ˆå€¼         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚  Closed  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚   Open   â”‚                   â”‚
â”‚    â”‚  (æ­£å¸¸)  â”‚                              â”‚  (ç†”æ–­)  â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â–²                                        â”‚                          â”‚
â”‚         â”‚                                        â”‚ å†·å´æ—¶é—´ç»“æŸ              â”‚
â”‚         â”‚ æˆåŠŸ                                   â–¼                          â”‚
â”‚         â”‚                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ HalfOpen â”‚                       â”‚
â”‚              (æ¢å¤æˆåŠŸ)                   â”‚  (åŠå¼€)  â”‚                       â”‚
â”‚                                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                â”‚                              â”‚
â”‚                                                â”‚ æˆåŠŸ â†’ Closed               â”‚
â”‚                                                â”‚ å¤±è´¥ â†’ Open                 â”‚
â”‚                                                â–¼                              â”‚
â”‚                                                                              â”‚
â”‚  é…ç½®:                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  failure_threshold: 5      # è¿ç»­ 5 æ¬¡å¤±è´¥è§¦å‘ç†”æ–­                     â”‚  â”‚
â”‚  â”‚  cooldown_secs: 30        # 30 ç§’åå°è¯•æ¢å¤                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  æ–¹æ³•:                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  allow_request(upstream_id) â†’ bool   # æ˜¯å¦å…è®¸è¯·æ±‚                   â”‚  â”‚
â”‚  â”‚  record_success(upstream_id)          # è®°å½•æˆåŠŸ                       â”‚  â”‚
â”‚  â”‚  record_failure(upstream_id, type)    # è®°å½•å¤±è´¥                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  FailureType:                                                                â”‚
â”‚  â”œâ”€â”€ ServerError      # 5xx é”™è¯¯                                           â”‚
â”‚  â”œâ”€â”€ Timeout          # è¶…æ—¶                                               â”‚
â”‚  â”œâ”€â”€ AuthFailed       # è®¤è¯å¤±è´¥                                           â”‚
â”‚  â”œâ”€â”€ PaymentRequired  # ä½™é¢ä¸è¶³                                           â”‚
â”‚  â”œâ”€â”€ RateLimited      # é™æµ                                               â”‚
â”‚  â””â”€â”€ ModelNotFound    # æ¨¡å‹ä¸å­˜åœ¨                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/ - åè®®é€‚é…å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            adaptor/                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  æ•´ä½“ç»“æ„:                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   mod.rs                                                               â”‚  â”‚
â”‚  â”‚   â””â”€â”€ Adaptor trait                                                    â”‚  â”‚
â”‚  â”‚       â”œâ”€â”€ convert_request(&OpenAIChatRequest) â†’ Option<Value>         â”‚  â”‚
â”‚  â”‚       â”œâ”€â”€ convert_response(Value) â†’ Option<Value>                      â”‚  â”‚
â”‚  â”‚       â”œâ”€â”€ convert_stream_response(&str) â†’ Option<String>               â”‚  â”‚
â”‚  â”‚       â””â”€â”€ build_request(...) â†’ RequestBuilder                         â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   factory.rs                                                           â”‚  â”‚
â”‚  â”‚   â””â”€â”€ DynamicAdaptorFactory                                            â”‚  â”‚
â”‚  â”‚       â”œâ”€â”€ cache: DashMap<(ChannelType, Option<String>), Adaptor>      â”‚  â”‚
â”‚  â”‚       â””â”€â”€ get_adaptor(channel_type, api_version) â†’ Adaptor            â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   dynamic.rs                                                           â”‚  â”‚
â”‚  â”‚   â””â”€â”€ DynamicAdaptor                                                   â”‚  â”‚
â”‚  â”‚       â””â”€â”€ ä»æ•°æ®åº“åŠ è½½ ProtocolConfigï¼Œè¿è¡Œæ—¶åè®®è½¬æ¢                   â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   detector.rs                                                          â”‚  â”‚
â”‚  â”‚   â””â”€â”€ ApiVersionDetector                                               â”‚  â”‚
â”‚  â”‚       â”œâ”€â”€ is_deprecation_error(msg) â†’ bool                             â”‚  â”‚
â”‚  â”‚       â””â”€â”€ detect_and_update() â†’ Result<Option<String>>                â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   mapping.rs                                                           â”‚  â”‚
â”‚  â”‚   â””â”€â”€ JSON å­—æ®µæ˜ å°„ï¼Œæ”¯æŒ JSONPath                                     â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   claude.rs                                                            â”‚  â”‚
â”‚  â”‚   â””â”€â”€ ClaudeAdaptor                                                    â”‚  â”‚
â”‚  â”‚       â”œâ”€â”€ OpenAI â†’ Anthropic è¯·æ±‚è½¬æ¢                                  â”‚  â”‚
â”‚  â”‚       â””â”€â”€ Anthropic â†’ OpenAI å“åº”è½¬æ¢                                  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   gemini.rs                                                            â”‚  â”‚
â”‚  â”‚   â””â”€â”€ GeminiAdaptor                                                    â”‚  â”‚
â”‚  â”‚       â”œâ”€â”€ OpenAI â†’ Gemini è¯·æ±‚è½¬æ¢                                     â”‚  â”‚
â”‚  â”‚       â””â”€â”€ Gemini â†’ OpenAI å“åº”è½¬æ¢                                     â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   vertex.rs                                                            â”‚  â”‚
â”‚  â”‚   â””â”€â”€ VertexAdaptor                                                    â”‚  â”‚
â”‚  â”‚       â””â”€â”€ Vertex AI ä¸“ç”¨é€‚é…                                           â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  åè®®è½¬æ¢ç¤ºä¾‹:                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  OpenAI è¯·æ±‚:                                                          â”‚  â”‚
â”‚  â”‚  { "model": "gpt-4", "messages": [{"role": "user", "content": "..."}] }â”‚  â”‚
â”‚  â”‚                           â”‚                                             â”‚  â”‚
â”‚  â”‚                           â–¼                                             â”‚  â”‚
â”‚  â”‚  Claude è¯·æ±‚:                                                          â”‚  â”‚
â”‚  â”‚  { "model": "claude-3", "messages": [...], "max_tokens": 1024 }        â”‚  â”‚
â”‚  â”‚                           â”‚                                             â”‚  â”‚
â”‚  â”‚                           â–¼                                             â”‚  â”‚
â”‚  â”‚  Gemini è¯·æ±‚:                                                          â”‚  â”‚
â”‚  â”‚  { "contents": [{"parts": [{"text": "..."}]}] }                        â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬å…«å±‚ï¼šæ–‡ä»¶çº§è¯¦è§£

### lib.rs - æ¨¡å—å…¥å£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               lib.rs                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  æ¨¡å—å£°æ˜:                                                                   â”‚
â”‚  pub mod adaptor;                                                            â”‚
â”‚  pub mod balancer;                                                           â”‚
â”‚  pub mod adaptive_limit;                                                     â”‚
â”‚  pub mod billing;                                                            â”‚
â”‚  pub mod channel_state;                                                      â”‚
â”‚  pub mod circuit_breaker;                                                    â”‚
â”‚  pub mod config;                                                             â”‚
â”‚  pub mod exchange_rate;                                                      â”‚
â”‚  pub mod limiter;                                                            â”‚
â”‚  pub mod model_router;                                                       â”‚
â”‚  pub mod notification;                                                       â”‚
â”‚  pub mod passthrough;                                                        â”‚
â”‚  pub mod price_sync;                                                         â”‚
â”‚  pub mod pricing_loader;                                                     â”‚
â”‚  pub mod response_parser;                                                    â”‚
â”‚  pub mod stream_parser;                                                      â”‚
â”‚  pub mod token_counter;                                                      â”‚
â”‚                                                                              â”‚
â”‚  æ ¸å¿ƒç»“æ„:                                                                   â”‚
â”‚  pub struct AppState {                                                       â”‚
â”‚      pub client: Client,                                                     â”‚
â”‚      pub config: Arc<RwLock<RouterConfig>>,                                  â”‚
â”‚      pub db: Arc<Database>,                                                  â”‚
â”‚      pub balancer: Arc<RoundRobinBalancer>,                                  â”‚
â”‚      pub limiter: Arc<RateLimiter>,                                          â”‚
â”‚      pub circuit_breaker: Arc<CircuitBreaker>,                               â”‚
â”‚      pub log_tx: mpsc::Sender<DbRouterLog>,                                  â”‚
â”‚      pub model_router: Arc<ModelRouter>,                                     â”‚
â”‚      pub channel_state: Arc<ChannelStateTracker>,                            â”‚
â”‚      pub adaptor_factory: Arc<DynamicAdaptorFactory>,                        â”‚
â”‚      pub api_version_detector: ApiVersionDetector,                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  æ ¸å¿ƒå‡½æ•°:                                                                   â”‚
â”‚  pub async fn create_router_app(db: Arc<Database>) -> Result<Router>         â”‚
â”‚  pub async fn proxy_handler(State(state), req: Request) -> Response          â”‚
â”‚  pub async fn proxy_logic(state, token_info, body, path) -> Result           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### config.rs - è·¯ç”±é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              config.rs                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct RouterConfig {                                                   â”‚
â”‚      pub upstreams: Vec<Upstream>,      // ä¸Šæ¸¸é€šé“åˆ—è¡¨                      â”‚
â”‚      pub groups: Vec<Group>,            // åˆ†ç»„é…ç½®                          â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct Upstream {                                                       â”‚
â”‚      pub id: String,                     // é€šé“ ID                          â”‚
â”‚      pub url: String,                    // ä¸Šæ¸¸ URL                         â”‚
â”‚      pub auth_type: AuthType,            // è®¤è¯ç±»å‹                         â”‚
â”‚      pub auth: Option<AuthConfig>,       // è®¤è¯é…ç½®                         â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct Group {                                                          â”‚
â”‚      pub name: String,                   // åˆ†ç»„å                           â”‚
â”‚      pub members: Vec<GroupMember>,      // æˆå‘˜åˆ—è¡¨                         â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum AuthType {                                                         â”‚
â”‚      Bearer,                             // Bearer Token                     â”‚
â”‚      ApiKey,                             // X-API-Key                        â”‚
â”‚      Aws,                                // AWS SigV4                        â”‚
â”‚      None,                               // æ— è®¤è¯                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl RouterConfig {                                                         â”‚
â”‚      pub fn find_route(&self, path: &str) -> Option<RouteResult>            â”‚
â”‚      pub fn reload(&mut self, db: &Database) -> Result<()>                  â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### billing.rs - è®¡è´¹è®¡ç®—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              billing.rs                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct AdvancedPricing {                                                â”‚
â”‚      pub input_price: i64,                                                   â”‚
â”‚      pub output_price: i64,                                                  â”‚
â”‚      pub cache_read_price: Option<i64>,                                      â”‚
â”‚      pub cache_creation_price: Option<i64>,                                  â”‚
â”‚      pub batch_input_price: Option<i64>,                                     â”‚
â”‚      pub batch_output_price: Option<i64>,                                    â”‚
â”‚      pub priority_input_price: Option<i64>,                                  â”‚
â”‚      pub priority_output_price: Option<i64>,                                 â”‚
â”‚      pub audio_input_price: Option<i64>,                                     â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub fn calculate_tiered_cost_full(...) -> i64                               â”‚
â”‚  // åˆ†æ®µç´¯åŠ è®¡è´¹ (Qwen æ¨¡å‹)                                                 â”‚
â”‚                                                                              â”‚
â”‚  pub fn calculate_cache_cost(...) -> i64                                     â”‚
â”‚  // Prompt Caching è®¡è´¹: cache_read 10%, cache_creation 25%                 â”‚
â”‚                                                                              â”‚
â”‚  pub fn calculate_batch_cost(...) -> i64                                     â”‚
â”‚  // æ‰¹é‡ API è®¡è´¹: é€šå¸¸ 50% æŠ˜æ‰£                                             â”‚
â”‚                                                                              â”‚
â”‚  pub fn calculate_priority_cost(...) -> i64                                  â”‚
â”‚  // ä¼˜å…ˆçº§è¯·æ±‚è®¡è´¹: é€šå¸¸ 170% æ ‡å‡†ä»·æ ¼                                       â”‚
â”‚                                                                              â”‚
â”‚  pub fn select_pricing_strategy(...) -> BillingStrategy                     â”‚
â”‚  // é€‰æ‹©è®¡è´¹ç­–ç•¥: cache > tiered > priority > batch > standard              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### circuit_breaker.rs - ç†”æ–­å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           circuit_breaker.rs                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct CircuitBreaker {                                                 â”‚
â”‚      states: DashMap<String, CircuitState>,  // æ¯é€šé“çŠ¶æ€                  â”‚
â”‚      config: CircuitBreakerConfig,                                            â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum CircuitState {                                                     â”‚
â”‚      Closed { failures: u32 },           // æ­£å¸¸çŠ¶æ€                        â”‚
â”‚      Open { until: Instant },            // ç†”æ–­çŠ¶æ€                        â”‚
â”‚      HalfOpen,                           // åŠå¼€çŠ¶æ€                         â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum FailureType {                                                      â”‚
â”‚      ServerError,                             // 5xx é”™è¯¯                    â”‚
â”‚      Timeout,                                 // è¶…æ—¶                        â”‚
â”‚      AuthFailed,                              // è®¤è¯å¤±è´¥                    â”‚
â”‚      PaymentRequired,                         // ä½™é¢ä¸è¶³                    â”‚
â”‚      RateLimited,                             // é™æµ                        â”‚
â”‚      ModelNotFound,                           // æ¨¡å‹ä¸å­˜åœ¨                  â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl CircuitBreaker {                                                       â”‚
â”‚      pub fn allow_request(&self, upstream_id: &str) -> bool                 â”‚
â”‚      pub fn record_success(&self, upstream_id: &str)                        â”‚
â”‚      pub fn record_failure(&self, upstream_id: &str, failure: FailureType)  â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### limiter.rs - åŸºç¡€é™æµå™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              limiter.rs                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct RateLimiter {                                                    â”‚
â”‚      buckets: DashMap<String, TokenBucket>,  // æ¯ç”¨æˆ·ä»¤ç‰Œæ¡¶                â”‚
â”‚      config: RateLimiterConfig,                                              â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct TokenBucket {                                                    â”‚
â”‚      tokens: f64,                          // å½“å‰ä»¤ç‰Œæ•°                     â”‚
â”‚      last_update: Instant,                 // ä¸Šæ¬¡æ›´æ–°æ—¶é—´                   â”‚
â”‚      refill_rate: f64,                     // å¡«å……é€Ÿç‡ (ä»¤ç‰Œ/ç§’)            â”‚
â”‚      max_tokens: f64,                      // æœ€å¤§ä»¤ç‰Œæ•°                     â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl RateLimiter {                                                          â”‚
â”‚      pub fn check(&self, key: &str, cost: f64) -> bool                      â”‚
â”‚      // æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚                                                    â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  é…ç½®:                                                                       â”‚
â”‚  â”œâ”€â”€ requests_per_second: 10.0                                              â”‚
â”‚  â””â”€â”€ burst_size: 20                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptive_limit.rs - è‡ªé€‚åº”é™æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           adaptive_limit.rs                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct AdaptiveLimiter {                                                â”‚
â”‚      states: DashMap<String, AdaptiveState>,                                 â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum AdaptiveState {                                                    â”‚
â”‚      Learning { ... },                    // å­¦ä¹ é˜¶æ®µ                       â”‚
â”‚      Stable { limit: u32 },               // ç¨³å®šé˜¶æ®µ                       â”‚
â”‚      Cooldown { ... },                    // å†·å´é˜¶æ®µ                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl AdaptiveLimiter {                                                      â”‚
â”‚      pub fn check(&self, channel_id: &str) -> bool                          â”‚
â”‚      pub fn record_success(&self, channel_id: &str)                         â”‚
â”‚      pub fn record_rate_limited(&self, channel_id: &str, retry_after: u64)  â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  å·¥ä½œåŸç†:                                                                   â”‚
â”‚  1. ä»ä¸Šæ¸¸å“åº”å¤´å­¦ä¹ é™æµä¿¡æ¯                                                â”‚
â”‚  2. è‡ªåŠ¨è°ƒæ•´æœ¬åœ°é™æµé˜ˆå€¼                                                    â”‚
â”‚  3. çŠ¶æ€æœº: Learning â†’ Stable â†’ Cooldown â†’ Learning                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### model_router.rs - æ¨¡å‹è·¯ç”±å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           model_router.rs                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct ModelRouter {                                                    â”‚
â”‚      abilities: DashMap<String, Vec<Ability>>,  // model â†’ abilities       â”‚
â”‚      db: Arc<Database>,                                                      â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct Ability {                                                        â”‚
â”‚      pub model: String,                   // æ¨¡å‹å                         â”‚
â”‚      pub channel_id: i32,                 // é€šé“ ID                        â”‚
â”‚      pub group: String,                   // ç”¨æˆ·ç»„                         â”‚
â”‚      pub enabled: bool,                   // æ˜¯å¦å¯ç”¨                       â”‚
â”‚      pub priority: i32,                   // ä¼˜å…ˆçº§                         â”‚
â”‚      pub weight: i32,                     // è´Ÿè½½å‡è¡¡æƒé‡                   â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl ModelRouter {                                                          â”‚
â”‚      pub fn route(&self, group: &str, model: &str) -> Vec<Channel>         â”‚
â”‚      // æŒ‰æ¨¡å‹åè·¯ç”±åˆ°é€šé“åˆ—è¡¨                                              â”‚
â”‚                                                                              â”‚
â”‚      pub fn route_with_state(&self, group, model, state) -> Vec<Channel>   â”‚
â”‚      // è€ƒè™‘é€šé“å¥åº·çŠ¶æ€çš„è·¯ç”±                                              â”‚
â”‚                                                                              â”‚
â”‚      pub fn reload(&self, db: &Database) -> Result<()>                     â”‚
â”‚      // é‡æ–°åŠ è½½è·¯ç”±é…ç½®                                                    â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### channel_state.rs - é€šé“çŠ¶æ€è¿½è¸ª

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          channel_state.rs                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct ChannelStateTracker {                                            â”‚
â”‚      states: DashMap<i32, ChannelState>,                                     â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct ChannelState {                                                   â”‚
â”‚      pub balance_status: BalanceStatus,   // ä½™é¢çŠ¶æ€                       â”‚
â”‚      pub model_status: HashMap<String, ModelStatus>,  // æ¨¡å‹çŠ¶æ€          â”‚
â”‚      pub last_check: Instant,             // ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´                   â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum BalanceStatus {                                                    â”‚
â”‚      Ok,                                  // æ­£å¸¸                           â”‚
â”‚      Low,                                 // ä½™é¢ä½                         â”‚
â”‚      Exhausted,                           // ä½™é¢è€—å°½                       â”‚
â”‚      Unknown,                             // æœªçŸ¥                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum ModelStatus {                                                      â”‚
â”‚      Available,                           // å¯ç”¨                           â”‚
â”‚      RateLimited { until: Instant },      // é™æµä¸­                         â”‚
â”‚      QuotaExhausted,                      // é…é¢è€—å°½                       â”‚
â”‚      ModelNotFound,                       // æ¨¡å‹ä¸å­˜åœ¨                     â”‚
â”‚      TemporarilyDown,                     // ä¸´æ—¶ä¸‹çº¿                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl ChannelStateTracker {                                                  â”‚
â”‚      pub fn is_channel_available(&self, channel_id: i32, model: &str)       â”‚
â”‚      pub fn update_model_status(&self, channel_id, model, status)           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### token_counter.rs - Token è®¡æ•°å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          token_counter.rs                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct TokenCounter {                                                   â”‚
â”‚      prompt_tokens: AtomicU64,           // è¾“å…¥ Token                      â”‚
â”‚      completion_tokens: AtomicU64,       // è¾“å‡º Token                      â”‚
â”‚      cache_read_tokens: AtomicU64,       // ç¼“å­˜è¯»å– Token                  â”‚
â”‚      cache_creation_tokens: AtomicU64,   // ç¼“å­˜åˆ›å»º Token                  â”‚
â”‚      audio_tokens: AtomicU64,            // éŸ³é¢‘ Token                      â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl TokenCounter {                                                         â”‚
â”‚      pub fn add_prompt(&self, count: u64)                                    â”‚
â”‚      pub fn add_completion(&self, count: u64)                                â”‚
â”‚      pub fn add_cache_read(&self, count: u64)                                â”‚
â”‚      pub fn add_cache_creation(&self, count: u64)                            â”‚
â”‚      pub fn add_audio(&self, count: u64)                                     â”‚
â”‚      pub fn get_totals(&self) -> TokenTotals                                 â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  çº¿ç¨‹å®‰å…¨: ä½¿ç”¨ AtomicU64 å®ç°æ— é”è®¡æ•°                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### stream_parser.rs - æµå¼å“åº”è§£æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          stream_parser.rs                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct StreamParser {                                                   â”‚
â”‚      provider: Provider,                                                     â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum Provider {                                                         â”‚
â”‚      OpenAI,                                                                 â”‚
â”‚      Anthropic,                                                              â”‚
â”‚      Gemini,                                                                 â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl StreamParser {                                                         â”‚
â”‚      pub fn parse_chunk(&self, line: &str) -> Option<StreamEvent>          â”‚
â”‚      // è§£æ SSE æ•°æ®å—                                                     â”‚
â”‚                                                                              â”‚
â”‚      pub fn extract_usage(&self, chunk: &str) -> Option<Usage>              â”‚
â”‚      // æå– Token ä½¿ç”¨é‡                                                   â”‚
â”‚                                                                              â”‚
â”‚      pub fn extract_cache_tokens(&self, chunk: &str) -> Option<CacheUsage>  â”‚
â”‚      // æå–ç¼“å­˜ Token (cache_read_input_tokens, cache_creation)            â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct StreamEvent {                                                    â”‚
â”‚      pub delta: Option<String>,           // å†…å®¹å¢é‡                       â”‚
â”‚      pub finish_reason: Option<String>,   // ç»“æŸåŸå›                        â”‚
â”‚      pub usage: Option<Usage>,            // Token ä½¿ç”¨                     â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### response_parser.rs - å“åº”è§£æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         response_parser.rs                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct ResponseParser;                                                  â”‚
â”‚                                                                              â”‚
â”‚  impl ResponseParser {                                                       â”‚
â”‚      pub fn parse_rate_limit_headers(headers: &HeaderMap) -> RateLimitInfo  â”‚
â”‚      // è§£æé™æµå¤´: x-ratelimit-*, retry-after                              â”‚
â”‚                                                                              â”‚
â”‚      pub fn parse_error(response: Response) -> ProviderError                â”‚
â”‚      // è§£æé”™è¯¯å“åº”                                                        â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct RateLimitInfo {                                                  â”‚
â”‚      pub limit: Option<u32>,              // è¯·æ±‚é™åˆ¶                       â”‚
â”‚      pub remaining: Option<u32>,          // å‰©ä½™è¯·æ±‚æ•°                     â”‚
â”‚      pub reset: Option<u64>,              // é‡ç½®æ—¶é—´æˆ³                     â”‚
â”‚      pub retry_after: Option<u64>,        // é‡è¯•ç­‰å¾…ç§’æ•°                   â”‚
â”‚      pub scope: Option<RateLimitScope>,   // é™æµèŒƒå›´                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum RateLimitScope {                                                   â”‚
â”‚      Request,                             // å•æ¬¡è¯·æ±‚                       â”‚
â”‚      Minute,                              // æ¯åˆ†é’Ÿ                         â”‚
â”‚      Hour,                                // æ¯å°æ—¶                         â”‚
â”‚      Day,                                 // æ¯å¤©                           â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### price_sync.rs - ä»·æ ¼åŒæ­¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           price_sync.rs                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub fn start_price_sync_task(db: Arc<Database>, interval_secs: u64)        â”‚
â”‚  // å¯åŠ¨åå°ä»·æ ¼åŒæ­¥ä»»åŠ¡                                                    â”‚
â”‚                                                                              â”‚
â”‚  pub async fn sync_prices_from_litellm(db: &Database) -> Result<SyncResult> â”‚
â”‚  // ä» LiteLLM åŒæ­¥ä»·æ ¼                                                     â”‚
â”‚                                                                              â”‚
â”‚  åŒæ­¥å†…å®¹:                                                                   â”‚
â”‚  â”œâ”€â”€ input_price / output_price         // æ ‡å‡†ä»·æ ¼                         â”‚
â”‚  â”œâ”€â”€ cache_read / cache_creation        // ç¼“å­˜ä»·æ ¼                         â”‚
â”‚  â”œâ”€â”€ batch_input / batch_output         // æ‰¹é‡ä»·æ ¼                         â”‚
â”‚  â”œâ”€â”€ priority_input / priority_output   // ä¼˜å…ˆçº§ä»·æ ¼                       â”‚
â”‚  â””â”€â”€ audio_input                        // éŸ³é¢‘ä»·æ ¼                         â”‚
â”‚                                                                              â”‚
â”‚  æ•°æ®æº: LiteLLM model_prices_and_context_window.json                       â”‚
â”‚  åŒæ­¥é¢‘ç‡: é»˜è®¤æ¯å°æ—¶                                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### notification.rs - é€šçŸ¥æœåŠ¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          notification.rs                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct NotificationService {                                            â”‚
â”‚      config: NotificationConfig,                                             â”‚
â”‚      rate_limiter: NotificationRateLimiter,                                  â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl NotificationService {                                                  â”‚
â”‚      pub async fn notify_new_model(&self, model: &str) -> Result<()>        â”‚
â”‚      pub async fn notify_missing_price(&self, model: &str) -> Result<()>    â”‚
â”‚      pub async fn notify_channel_error(&self, channel: &str) -> Result<()>  â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  é€šçŸ¥ç±»å‹:                                                                   â”‚
â”‚  â”œâ”€â”€ Webhook                            // HTTP POST                        â”‚
â”‚  â”œâ”€â”€ Slack                              // Slack Incoming Webhook           â”‚
â”‚  â””â”€â”€ Discord                            // Discord Webhook                  â”‚
â”‚                                                                              â”‚
â”‚  é™æµ: é˜²æ­¢é€šçŸ¥é£æš´ï¼Œæ¯ç±»å‹æ¯å°æ—¶æœ€å¤š N æ¡                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### exchange_rate.rs - æ±‡ç‡ç®¡ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         exchange_rate.rs                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct ExchangeRateService {                                            â”‚
â”‚      db: Arc<Database>,                                                      â”‚
â”‚      cache: DashMap<(String, String), i64>,  // (from, to) â†’ scaled_rate   â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl ExchangeRateService {                                                  â”‚
â”‚      pub async fn get_rate(&self, from: &str, to: &str) -> Result<i64>      â”‚
â”‚      // è·å–æ±‡ç‡ (ç¼©æ”¾åçš„ i64)                                             â”‚
â”‚                                                                              â”‚
â”‚      pub async fn convert(&self, amount: i64, from, to) -> Result<i64>      â”‚
â”‚      // è´§å¸è½¬æ¢                                                            â”‚
â”‚                                                                              â”‚
â”‚      pub async fn update_rate(&self, from, to, rate: f64) -> Result<()>     â”‚
â”‚      // æ›´æ–°æ±‡ç‡                                                            â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  æ±‡ç‡å­˜å‚¨: ä½¿ç”¨ i64 ç¼©æ”¾ (Ã—10^9) ä¿è¯ç²¾åº¦                                   â”‚
â”‚  ä¾‹: USD/CNY 7.2 â†’ 7_200_000_000                                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### passthrough.rs - é€ä¼ æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          passthrough.rs                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub fn should_passthrough(path: &str, body: &[u8], channel_type: i32)      â”‚
â”‚      â†’ bool                                                                  â”‚
â”‚  // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨é€ä¼ æ¨¡å¼                                                    â”‚
â”‚                                                                              â”‚
â”‚  é€ä¼ æ¡ä»¶:                                                                   â”‚
â”‚  â”œâ”€â”€ è¯·æ±‚ä½“ä¸ºç©º                             // ç©º body                      â”‚
â”‚  â”œâ”€â”€ é JSON å†…å®¹                           // æ–‡ä»¶ä¸Šä¼ ç­‰                   â”‚
â”‚  â”œâ”€â”€ ç‰¹æ®Šè·¯å¾„ (å¦‚ /files, /images)          // æ–‡ä»¶æ“ä½œ                     â”‚
â”‚  â””â”€â”€ åŸç”Ÿåè®®è¯·æ±‚                           // ä¸éœ€è¦è½¬æ¢                    â”‚
â”‚                                                                              â”‚
â”‚  é€ä¼ æ¨¡å¼:                                                                   â”‚
â”‚  1. ä¸è§£æè¯·æ±‚ä½“                                                            â”‚
â”‚  2. ç›´æ¥è½¬å‘åŸå§‹å­—èŠ‚                                                        â”‚
â”‚  3. é›¶å»¶è¿Ÿæµå¼å“åº”                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### pricing_loader.rs - ä»·æ ¼åŠ è½½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         pricing_loader.rs                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub fn load_pricing_from_file(path: &str) -> Result<PricingConfig>         â”‚
â”‚  // ä» JSON æ–‡ä»¶åŠ è½½ä»·æ ¼é…ç½®                                                â”‚
â”‚                                                                              â”‚
â”‚  pub fn load_pricing_from_dir(dir: &str) -> Result<Vec<PricingConfig>>      â”‚
â”‚  // ä»ç›®å½•åŠ è½½æ‰€æœ‰ä»·æ ¼é…ç½®                                                  â”‚
â”‚                                                                              â”‚
â”‚  pub fn merge_pricing_configs(configs: Vec<PricingConfig>) -> PricingConfig â”‚
â”‚  // åˆå¹¶å¤šä¸ªä»·æ ¼é…ç½®                                                        â”‚
â”‚                                                                              â”‚
â”‚  é…ç½®æ–‡ä»¶æ ¼å¼: pricing.json                                                  â”‚
â”‚  {                                                                           â”‚
â”‚    "version": "1.0",                                                         â”‚
â”‚    "source": "official",                                                     â”‚
â”‚    "models": {                                                               â”‚
â”‚      "gpt-4": {                                                              â”‚
â”‚        "usd": { "input_price": 30.0, "output_price": 60.0 },                â”‚
â”‚        "tiered": [...]                                                       â”‚
â”‚      }                                                                       â”‚
â”‚    }                                                                         â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/mod.rs - åè®®é€‚é…å™¨æ¥å£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           adaptor/mod.rs                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub trait Adaptor: Send + Sync {                                            â”‚
â”‚      fn channel_type(&self) -> ChannelType;                                  â”‚
â”‚                                                                              â”‚
â”‚      fn convert_request(&self, req: &OpenAIChatRequest) -> Option<Value>;   â”‚
â”‚      // è½¬æ¢è¯·æ±‚: OpenAI â†’ ä¸Šæ¸¸æ ¼å¼                                         â”‚
â”‚                                                                              â”‚
â”‚      fn convert_response(&self, resp: Value) -> Option<Value>;              â”‚
â”‚      // è½¬æ¢å“åº”: ä¸Šæ¸¸æ ¼å¼ â†’ OpenAI                                         â”‚
â”‚                                                                              â”‚
â”‚      fn convert_stream_response(&self, chunk: &str) -> Option<String>;      â”‚
â”‚      // è½¬æ¢æµå¼å“åº”                                                        â”‚
â”‚                                                                              â”‚
â”‚      fn build_request(&self, base_url: &str, req: RequestBuilder,           â”‚
â”‚                        body: Value, auth: &AuthConfig) -> RequestBuilder;   â”‚
â”‚      // æ„å»ºè¯·æ±‚                                                            â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/factory.rs - åŠ¨æ€é€‚é…å™¨å·¥å‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         adaptor/factory.rs                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct DynamicAdaptorFactory {                                          â”‚
â”‚      cache: DashMap<(ChannelType, Option<String>), Arc<dyn Adaptor>>,       â”‚
â”‚      db: Arc<Database>,                                                      â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl DynamicAdaptorFactory {                                                â”‚
â”‚      pub fn get_adaptor(&self, channel_type: ChannelType,                   â”‚
â”‚                          api_version: Option<&str>) -> Arc<dyn Adaptor>     â”‚
â”‚      // è·å–æˆ–åˆ›å»ºé€‚é…å™¨ (å¸¦ç¼“å­˜)                                           â”‚
â”‚                                                                              â”‚
â”‚      pub fn invalidate_cache(&self, channel_type: ChannelType)              â”‚
â”‚      // ä½¿ç¼“å­˜å¤±æ•ˆ                                                          â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  ç¼“å­˜é”®: (ChannelType, api_version)                                         â”‚
â”‚  ä¾‹: (OpenAI, "2024-01-01"), (Anthropic, "2023-06-01")                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/dynamic.rs - åŠ¨æ€åè®®é€‚é…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         adaptor/dynamic.rs                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct DynamicAdaptor {                                                 â”‚
â”‚      config: ProtocolConfig,              // ä»æ•°æ®åº“åŠ è½½                   â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct ProtocolConfig {                                                 â”‚
â”‚      pub channel_type: ChannelType,                                          â”‚
â”‚      pub api_version: String,                                                â”‚
â”‚      pub chat_endpoint: String,           // ç«¯ç‚¹æ¨¡æ¿                       â”‚
â”‚      pub request_mapping: Vec<FieldMapping>,  // è¯·æ±‚æ˜ å°„                   â”‚
â”‚      pub response_mapping: Vec<FieldMapping>, // å“åº”æ˜ å°„                   â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl DynamicAdaptor {                                                       â”‚
â”‚      fn apply_mapping(&self, value: &Value, mappings: &[FieldMapping])      â”‚
â”‚      // åº”ç”¨å­—æ®µæ˜ å°„                                                        â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  ç”¨é€”: æ”¯æŒè¿è¡Œæ—¶é…ç½®çš„åè®®è½¬æ¢ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/detector.rs - API ç‰ˆæœ¬æ£€æµ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         adaptor/detector.rs                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct ApiVersionDetector {                                             â”‚
â”‚      patterns: Vec<DeprecationPattern>,                                      â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct DeprecationPattern {                                             â”‚
â”‚      pub provider: String,                // OpenAI, Azure, etc.            â”‚
â”‚      pub pattern: Regex,                  // åŒ¹é…æ­£åˆ™                       â”‚
â”‚      pub new_version: String,             // æ–°ç‰ˆæœ¬å·                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl ApiVersionDetector {                                                   â”‚
â”‚      pub fn is_deprecation_error(&self, msg: &str) -> bool                  â”‚
â”‚      // æ£€æµ‹æ˜¯å¦ä¸ºåºŸå¼ƒç‰ˆæœ¬é”™è¯¯                                              â”‚
â”‚                                                                              â”‚
â”‚      pub fn detect_and_update(&self, channel_id: i32, msg: &str, db: &Databaseâ”‚
â”‚          ) -> Result<Option<String>>                                         â”‚
â”‚      // æ£€æµ‹å¹¶è‡ªåŠ¨æ›´æ–° API ç‰ˆæœ¬                                             â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  ç¤ºä¾‹: OpenAI åºŸå¼ƒ "2023-05-15" â†’ è‡ªåŠ¨æ›´æ–°åˆ° "2024-01-01"                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/mapping.rs - JSON å­—æ®µæ˜ å°„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          adaptor/mapping.rs                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct FieldMapping {                                                   â”‚
â”‚      pub from: String,                    // æºå­—æ®µè·¯å¾„                     â”‚
â”‚      pub to: String,                      // ç›®æ ‡å­—æ®µè·¯å¾„                   â”‚
â”‚      pub transform: Option<Transform>,    // è½¬æ¢å‡½æ•°                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub enum Transform {                                                        â”‚
â”‚      Identity,                            // ä¸è½¬æ¢                          â”‚
â”‚      Rename(String),                      // é‡å‘½å                          â”‚
â”‚      Format(FormatType),                  // æ ¼å¼åŒ–                          â”‚
â”‚      Custom(String),                      // è‡ªå®šä¹‰è¡¨è¾¾å¼                    â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub fn apply_mapping(value: &Value, mapping: &FieldMapping) -> Value       â”‚
â”‚  // åº”ç”¨å•ä¸ªæ˜ å°„                                                            â”‚
â”‚                                                                              â”‚
â”‚  pub fn apply_mappings(value: &Value, mappings: &[FieldMapping]) -> Value   â”‚
â”‚  // åº”ç”¨å¤šä¸ªæ˜ å°„                                                            â”‚
â”‚                                                                              â”‚
â”‚  æ”¯æŒ: JSONPath è¡¨è¾¾å¼, åµŒå¥—å­—æ®µ, æ•°ç»„éå†                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/claude.rs - Anthropic é€‚é…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          adaptor/claude.rs                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct ClaudeAdaptor;                                                   â”‚
â”‚                                                                              â”‚
â”‚  impl Adaptor for ClaudeAdaptor {                                            â”‚
â”‚      fn channel_type(&self) -> ChannelType { ChannelType::Anthropic }       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  è¯·æ±‚è½¬æ¢ (OpenAI â†’ Anthropic):                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  { "model": "gpt-4",            â†’  { "model": "claude-3",           â”‚    â”‚
â”‚  â”‚    "messages": [...],               "messages": [...],               â”‚    â”‚
â”‚  â”‚    "max_tokens": 1024,              "max_tokens": 1024,              â”‚    â”‚
â”‚  â”‚    "stream": true }                 "stream": true }                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  å“åº”è½¬æ¢ (Anthropic â†’ OpenAI):                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  { "content": [...],            â†’  { "choices": [...],              â”‚    â”‚
â”‚  â”‚    "usage": {...},                  "usage": {...},                  â”‚    â”‚
â”‚  â”‚    "stop_reason": "end_turn" }      "finish_reason": "stop" }        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  ç‰¹æ®Šå¤„ç†: Prompt Caching (cache_control), system æ¶ˆæ¯ä½ç½®                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/gemini.rs - Google Gemini é€‚é…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          adaptor/gemini.rs                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct GeminiAdaptor;                                                   â”‚
â”‚                                                                              â”‚
â”‚  impl Adaptor for GeminiAdaptor {                                            â”‚
â”‚      fn channel_type(&self) -> ChannelType { ChannelType::Gemini }          â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  è¯·æ±‚è½¬æ¢ (OpenAI â†’ Gemini):                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  { "model": "gpt-4",            â†’  { "contents": [                   â”‚    â”‚
â”‚  â”‚    "messages": [                    { "parts": [{"text": "..."}]}],  â”‚    â”‚
â”‚  â”‚      {"role": "user",               "generationConfig": {...}        â”‚    â”‚
â”‚  â”‚       "content": "..."}]          }                                   â”‚    â”‚
â”‚  â”‚  }                                                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  å“åº”è½¬æ¢ (Gemini â†’ OpenAI):                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  { "candidates": [...],         â†’  { "choices": [...],              â”‚    â”‚
â”‚  â”‚    "usageMetadata": {...} }         "usage": {...} }                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  ç‰¹æ®Šå¤„ç†: role æ˜ å°„ (user/model), safetySettings                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### adaptor/vertex.rs - Vertex AI é€‚é…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          adaptor/vertex.rs                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct VertexAdaptor;                                                   â”‚
â”‚                                                                              â”‚
â”‚  impl Adaptor for VertexAdaptor {                                            â”‚
â”‚      fn channel_type(&self) -> ChannelType { ChannelType::VertexAi }        â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  ç‰¹æ®Šè®¤è¯:                                                                   â”‚
â”‚  â”œâ”€â”€ GCP Service Account                                                    â”‚
â”‚  â”œâ”€â”€ OAuth2 Token                                                           â”‚
â”‚  â””â”€â”€ éœ€è¦é¡¹ç›® ID å’ŒåŒºåŸŸ                                                    â”‚
â”‚                                                                              â”‚
â”‚  ç«¯ç‚¹æ ¼å¼:                                                                   â”‚
â”‚  https://{region}-aiplatform.googleapis.com/v1/projects/{project}           â”‚
â”‚    /locations/{region}/publishers/google/models/{model}:predict             â”‚
â”‚                                                                              â”‚
â”‚  æ”¯æŒæ¨¡å‹: Gemini on Vertex, Claude on Vertex, PaLM                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### balancer/mod.rs - è´Ÿè½½å‡è¡¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          balancer/mod.rs                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  pub struct RoundRobinBalancer {                                             â”‚
â”‚      counters: DashMap<String, AtomicU32>,  // æ¯ç»„è®¡æ•°å™¨                   â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  impl RoundRobinBalancer {                                                   â”‚
â”‚      pub fn select<'a>(&self, members: &'a [GroupMember])                   â”‚
â”‚          -> Option<&'a GroupMember>                                          â”‚
â”‚      // è½®è¯¢é€‰æ‹©æˆå‘˜                                                        â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  pub struct GroupMember {                                                    â”‚
â”‚      pub upstream_id: String,            // ä¸Šæ¸¸ ID                         â”‚
â”‚      pub weight: u32,                    // æƒé‡ (æš‚æœªä½¿ç”¨)                 â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  ç®—æ³•: ç®€å•è½®è¯¢ (Round Robin)                                                â”‚
â”‚  æœªæ¥: åŠ æƒè½®è¯¢ (Weighted Round Robin)                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ä¾èµ–å…³ç³»

```
burncloud-router
â”‚
â”œâ”€â”€ burncloud-common          # å…±äº«ç±»å‹
â”‚   â”œâ”€â”€ types                 # User, Token, Channel, Price
â”‚   â”œâ”€â”€ price_u64             # çº³ç¾å…ƒå¤„ç†
â”‚   â””â”€â”€ pricing_config        # å®šä»·é…ç½®
â”‚
â”œâ”€â”€ burncloud-database        # æ•°æ®åº“è®¿é—®
â”‚   â”œâ”€â”€ database-router       # Token éªŒè¯ã€æ—¥å¿—å†™å…¥
â”‚   â””â”€â”€ database-models       # ä»·æ ¼æŸ¥è¯¢
â”‚
â”œâ”€â”€ router-aws (å­ crate)     # AWS SigV4 ç­¾å
â”‚
â””â”€â”€ external
    â”œâ”€â”€ axum                  # Web æ¡†æ¶
    â”œâ”€â”€ reqwest               # HTTP å®¢æˆ·ç«¯
    â”œâ”€â”€ tokio                 # å¼‚æ­¥è¿è¡Œæ—¶
    â””â”€â”€ serde_json            # JSON å¤„ç†
```
