# router-aws

AWS SigV4 签名模块，用于 AWS Bedrock 等服务的认证。

## 🧅 第一层：在 Router 中的位置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          协议适配流程                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   请求到达 Router                                                            │
│        │                                                                     │
│        ▼                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  判断通道类型                                                        │   │
│   │                                                                      │   │
│   │  ChannelType::OpenAI     → 标准 Bearer Token                        │   │
│   │  ChannelType::Anthropic  → 标准 Bearer Token                        │   │
│   │  ChannelType::Bedrock    → ★ 需要 AWS SigV4 签名                    │   │
│   │  ChannelType::VertexAi   → 需要 OAuth2 Token                        │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│        │                                                                     │
│        │ AWS 通道                                                            │
│        ▼                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      router-aws                                      │   │
│   │                                                                      │   │
│   │   生成 SigV4 签名 → 添加到请求头 → 发送到 AWS                        │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

router-aws 的职责:
├── 生成 AWS SigV4 签名
├── 管理 AWS 凭证
├── 计算签名哈希
└── 构建 Authorization 头
```

## 🧅 第二层：文件结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         router-aws 文件结构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  crates/router/crates/router-aws/                                            │
│  │                                                                           │
│  ├── Cargo.toml           # 依赖配置                                        │
│  └── src/                                                                    │
│      └── lib.rs           # AWS SigV4 签名实现                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第三层：lib.rs 详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              lib.rs                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  什么是 AWS SigV4?                                                           │
│  ─────────────────                                                           │
│  AWS 使用的签名协议，用于验证 API 请求的身份和完整性。                       │
│  所有请求到 AWS 服务（如 Bedrock、S3）都需要这个签名。                       │
│                                                                              │
│  签名流程:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  1. 准备凭证                                                         │   │
│  │     ├── Access Key ID      (类似用户名)                              │   │
│  │     ├── Secret Access Key  (类似密码)                                │   │
│  │     └── Region             (如 us-east-1)                            │   │
│  │                                                                      │   │
│  │  2. 创建规范请求 (Canonical Request)                                 │   │
│  │     ├── HTTP 方法 (POST)                                             │   │
│  │     ├── URL 路径                                                     │   │
│  │     ├── 查询字符串                                                   │   │
│  │     ├── 请求头 (按字母排序)                                          │   │
│  │     └── 请求体哈希                                                   │   │
│  │                                                                      │   │
│  │  3. 创建待签字符串 (String to Sign)                                  │   │
│  │     ├── 算法标识                                                     │   │
│  │     ├── 时间戳                                                       │   │
│  │     ├── 凭证范围                                                     │   │
│  │     └── 规范请求的哈希                                               │   │
│  │                                                                      │   │
│  │  4. 计算签名                                                         │   │
│  │     └── 使用 Secret Key 进行 HMAC-SHA256                             │   │
│  │                                                                      │   │
│  │  5. 添加 Authorization 头                                           │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第四层：核心结构和函数

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          核心代码结构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  /// AWS 凭证                                                                │
│  pub struct AwsCredentials {                                                 │
│      pub access_key_id: String,        // AKIA...                           │
│      pub secret_access_key: String,    // 加密的密钥                        │
│      pub session_token: Option<String>, // 临时凭证时使用                   │
│  }                                                                           │
│                                                                              │
│  /// 签名配置                                                                │
│  pub struct SigningConfig {                                                  │
│      pub region: String,               // us-east-1, eu-west-1, ...         │
│      pub service: String,              // bedrock, s3, ...                  │
│      pub method: String,               // POST, GET, ...                    │
│      pub path: String,                 // /model/xxx/invoke                 │
│  }                                                                           │
│                                                                              │
│  /// 生成签名                                                                │
│  pub fn sign_request(                                                        │
│      credentials: &AwsCredentials,                                           │
│      config: &SigningConfig,                                                 │
│      headers: &mut HeaderMap,                                                │
│      body: &[u8],                                                            │
│  ) -> Result<()>                                                             │
│  {                                                                           │
│      // 1. 添加必要的时间戳头                                                │
│      // 2. 计算请求体哈希                                                    │
│      // 3. 创建规范请求                                                      │
│      // 4. 创建待签字符串                                                    │
│      // 5. 计算签名                                                          │
│      // 6. 添加 Authorization 头                                            │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第五层：签名示例

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          签名示例                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  原始请求:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  POST /model/anthropic.claude-3-sonnet/invoke HTTP/1.1              │   │
│  │  Host: bedrock-runtime.us-east-1.amazonaws.com                      │   │
│  │  Content-Type: application/json                                     │   │
│  │                                                                      │   │
│  │  {"prompt": "Hello", "max_tokens": 100}                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  签名后请求:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  POST /model/anthropic.claude-3-sonnet/invoke HTTP/1.1              │   │
│  │  Host: bedrock-runtime.us-east-1.amazonaws.com                      │   │
│  │  Content-Type: application/json                                     │   │
│  │  X-Amz-Date: 20240101T120000Z                                       │   │
│  │  Authorization: AWS4-HMAC-SHA256                                     │   │
│  │    Credential=AKIAIOSFODNN7EXAMPLE/20240101/us-east-1/bedrock/      │   │
│  │    aws4_request,                                                     │   │
│  │    SignedHeaders=content-type;host;x-amz-date,                      │   │
│  │    Signature=abcd1234...                                             │   │
│  │                                                                      │   │
│  │  {"prompt": "Hello", "max_tokens": 100}                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 依赖关系

```
router-aws
├── burncloud-common
│   └── types (ChannelType::Bedrock)
└── external
    ├── hmac               # HMAC 计算
    ├── sha2               # SHA256 哈希
    └── hex                # 十六进制编码
```
