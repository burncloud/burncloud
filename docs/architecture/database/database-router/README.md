# database-router

è·¯ç”±æ•°æ®è®¿é—®å±‚ï¼Œå¤„ç† Token éªŒè¯ã€é…é¢ã€æ—¥å¿—ç­‰ã€‚

## ğŸ§… ç¬¬ä¸€å±‚ï¼šåœ¨ Database ä¸­çš„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          burncloud-database                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        æ•°æ®åº“å±‚                                      â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚   â”‚   â”‚â˜…database-routerâ”‚  â”‚ database-user  â”‚  â”‚ database-models    â”‚    â”‚   â”‚
â”‚   â”‚   â”‚                â”‚  â”‚                â”‚  â”‚                    â”‚    â”‚   â”‚
â”‚   â”‚   â”‚ Token éªŒè¯     â”‚  â”‚ ç”¨æˆ· CRUD      â”‚  â”‚ ä»·æ ¼ç®¡ç†           â”‚    â”‚   â”‚
â”‚   â”‚   â”‚ é…é¢ç®¡ç†       â”‚  â”‚ ä½™é¢æ“ä½œ       â”‚  â”‚ æ¨¡å‹é…ç½®           â”‚    â”‚   â”‚
â”‚   â”‚   â”‚ æ—¥å¿—å­˜å‚¨       â”‚  â”‚                â”‚  â”‚                    â”‚    â”‚   â”‚
â”‚   â”‚   â”‚ é€šé“é…ç½®       â”‚  â”‚                â”‚  â”‚                    â”‚    â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

database-router çš„èŒè´£:
â”œâ”€â”€ Token éªŒè¯å’ŒæŸ¥è¯¢
â”œâ”€â”€ é…é¢æ‰£é™¤å’ŒæŸ¥è¯¢
â”œâ”€â”€ è¯·æ±‚æ—¥å¿—å­˜å‚¨
â”œâ”€â”€ é€šé“å’Œè·¯ç”±é…ç½®
â””â”€â”€ åˆ†ç»„å’Œæƒé™é…ç½®
```

## ğŸ§… ç¬¬äºŒå±‚ï¼šæ–‡ä»¶ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       database-router æ–‡ä»¶ç»“æ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  crates/database/crates/database-router/                                     â”‚
â”‚  â”‚                                                                           â”‚
â”‚  â”œâ”€â”€ Cargo.toml           # ä¾èµ–é…ç½®                                        â”‚
â”‚  â””â”€â”€ src/                                                                    â”‚
â”‚      â””â”€â”€ lib.rs           # æ‰€æœ‰æ•°æ®è®¿é—®å‡½æ•°                                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬ä¸‰å±‚ï¼šlib.rs è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              lib.rs                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  æ¨¡å—èŒè´£: Router çš„æ‰€æœ‰æ•°æ®åº“æ“ä½œ                                           â”‚
â”‚                                                                              â”‚
â”‚  æ“ä½œçš„æ•°æ®è¡¨:                                                               â”‚
â”‚  â”œâ”€â”€ tokens           # API Token                                           â”‚
â”‚  â”œâ”€â”€ channels         # ä¸Šæ¸¸é€šé“                                            â”‚
â”‚  â”œâ”€â”€ abilities        # æ¨¡å‹-é€šé“æ˜ å°„                                       â”‚
â”‚  â”œâ”€â”€ groups           # ç”¨æˆ·åˆ†ç»„                                            â”‚
â”‚  â”œâ”€â”€ group_members    # åˆ†ç»„æˆå‘˜                                            â”‚
â”‚  â””â”€â”€ router_logs      # è¯·æ±‚æ—¥å¿—                                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬å››å±‚ï¼šToken éªŒè¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Token éªŒè¯æµç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  /// Token éªŒè¯ç»“æœ                                                          â”‚
â”‚  pub enum TokenValidationResult {                                            â”‚
â”‚      Valid(TokenInfo),       // æœ‰æ•ˆï¼Œè¿”å› Token ä¿¡æ¯                       â”‚
â”‚      Expired,                // å·²è¿‡æœŸ                                      â”‚
â”‚      Invalid,                // æ— æ•ˆ (ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨)                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  /// Token ä¿¡æ¯                                                              â”‚
â”‚  pub struct TokenInfo {                                                      â”‚
â”‚      pub user_id: String,           // ç”¨æˆ· ID                              â”‚
â”‚      pub group: String,             // ç”¨æˆ·ç»„                               â”‚
â”‚      pub quota_limit: i64,          // é…é¢é™åˆ¶ (çº³ç¾å…ƒ)                    â”‚
â”‚      pub used_quota: i64,           // å·²ä½¿ç”¨ (çº³ç¾å…ƒ)                      â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  éªŒè¯æµç¨‹:                                                                   â”‚
â”‚                                                                              â”‚
â”‚   è¯·æ±‚æºå¸¦ sk-xxx Token                                                      â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  validate_token_and_get_info(db, token)                             â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  1. æŸ¥è¯¢ tokens è¡¨                                                   â”‚  â”‚
â”‚   â”‚     SELECT user_id, status, quota_limit, used_quota, expired_time   â”‚  â”‚
â”‚   â”‚     FROM tokens WHERE key = ?                                        â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  2. æ£€æŸ¥çŠ¶æ€                                                         â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ æœªæ‰¾åˆ° â†’ Invalid                                             â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ status = 0 â†’ Invalid                                         â”‚  â”‚
â”‚   â”‚     â””â”€â”€ status = 1 â†’ ç»§ç»­                                            â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  3. æ£€æŸ¥è¿‡æœŸ                                                         â”‚  â”‚
â”‚   â”‚     â””â”€â”€ expired_time < now â†’ Expired                                â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  4. è¿”å› Valid(TokenInfo)                                           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  pub async fn validate_token_detailed(db: &Database, token: &str)           â”‚
â”‚      -> TokenValidationResult                                                â”‚
â”‚                                                                              â”‚
â”‚  pub async fn validate_token_and_get_info(db: &Database, token: &str)       â”‚
â”‚      -> Result<(String, String, i64, i64)>                                   â”‚
â”‚      // è¿”å›: (user_id, group, quota_limit, used_quota)                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬äº”å±‚ï¼šé…é¢æ“ä½œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            é…é¢æ“ä½œ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  /// æ‰£é™¤é…é¢                                                                 â”‚
â”‚  pub async fn deduct_quota(                                                  â”‚
â”‚      db: &Database,                                                          â”‚
â”‚      user_id: &str,                                                          â”‚
â”‚      token: &str,                                                            â”‚
â”‚      amount: i64,                     // æ‰£é™¤é‡‘é¢ (çº³ç¾å…ƒ)                  â”‚
â”‚  ) -> Result<()>                                                             â”‚
â”‚                                                                              â”‚
â”‚  å®ç°é€»è¾‘:                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  -- 1. æ‰£é™¤ç”¨æˆ·ä½™é¢                                                  â”‚   â”‚
â”‚  â”‚  UPDATE users SET balance_usd = balance_usd - ?                     â”‚   â”‚
â”‚  â”‚  WHERE id = ?;                                                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  -- 2. å¢åŠ  Token å·²ç”¨é…é¢                                           â”‚   â”‚
â”‚  â”‚  UPDATE tokens SET used_quota = used_quota + ?,                     â”‚   â”‚
â”‚  â”‚    accessed_time = datetime('now')                                  â”‚   â”‚
â”‚  â”‚  WHERE key = ?;                                                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  COMMIT;                                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  æ³¨æ„äº‹é¡¹:                                                                   â”‚
â”‚  â”œâ”€â”€ ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§                                                     â”‚
â”‚  â”œâ”€â”€ ä½™é¢ä¸è¶³æ—¶äº‹åŠ¡ä¼šå¤±è´¥                                                   â”‚
â”‚  â””â”€â”€ åŒæ—¶æ›´æ–° Token è®¿é—®æ—¶é—´                                                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬å…­å±‚ï¼šé…ç½®åŠ è½½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            é…ç½®åŠ è½½                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  /// è·å–æ‰€æœ‰ä¸Šæ¸¸é€šé“                                                        â”‚
â”‚  pub async fn get_all_upstreams(db: &Database) -> Result<Vec<DbUpstream>>   â”‚
â”‚                                                                              â”‚
â”‚  /// è·å–æ‰€æœ‰åˆ†ç»„                                                            â”‚
â”‚  pub async fn get_all_groups(db: &Database) -> Result<Vec<DbGroup>>         â”‚
â”‚                                                                              â”‚
â”‚  /// è·å–åˆ†ç»„æˆå‘˜                                                            â”‚
â”‚  pub async fn get_group_members(db: &Database, group: &str)                 â”‚
â”‚      -> Result<Vec<DbGroupMember>>                                           â”‚
â”‚                                                                              â”‚
â”‚  /// è·å–ç”¨æˆ·æ‰€å±ç»„                                                          â”‚
â”‚  pub async fn get_user_group(db: &Database, user_id: &str)                  â”‚
â”‚      -> Result<String>                                                       â”‚
â”‚                                                                              â”‚
â”‚  æ•°æ®åŠ è½½æµç¨‹ (Router å¯åŠ¨æ—¶):                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1. åŠ è½½æ‰€æœ‰é€šé“                                                     â”‚   â”‚
â”‚  â”‚     SELECT * FROM channels WHERE status = 1                          â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  2. åŠ è½½æ‰€æœ‰èƒ½åŠ›æ˜ å°„                                                 â”‚   â”‚
â”‚  â”‚     SELECT * FROM abilities WHERE enabled = 1                        â”‚   â”‚
â”‚  â”‚     (model â†’ channel æ˜ å°„)                                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  3. åŠ è½½æ‰€æœ‰åˆ†ç»„                                                     â”‚   â”‚
â”‚  â”‚     SELECT * FROM groups                                             â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  4. æ„å»º RouterConfig                                                â”‚   â”‚
â”‚  â”‚     - upstreams: é€šé“åˆ—è¡¨                                            â”‚   â”‚
â”‚  â”‚     - groups: åˆ†ç»„é…ç½®                                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ç¬¬ä¸ƒå±‚ï¼šæ—¥å¿—å­˜å‚¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ—¥å¿—å­˜å‚¨                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  /// æ—¥å¿—è®°å½•ç»“æ„                                                            â”‚
â”‚  pub struct DbRouterLog {                                                    â”‚
â”‚      pub request_id: String,         // è¯·æ±‚å”¯ä¸€ ID                         â”‚
â”‚      pub user_id: Option<String>,    // ç”¨æˆ· ID                            â”‚
â”‚      pub path: String,               // è¯·æ±‚è·¯å¾„                            â”‚
â”‚      pub upstream_id: Option<String>,// ä¸Šæ¸¸é€šé“ ID                         â”‚
â”‚      pub status_code: i32,           // HTTP çŠ¶æ€ç                          â”‚
â”‚      pub latency_ms: i64,            // å»¶è¿Ÿæ¯«ç§’                            â”‚
â”‚      pub prompt_tokens: i32,         // è¾“å…¥ Token                          â”‚
â”‚      pub completion_tokens: i32,     // è¾“å‡º Token                          â”‚
â”‚      pub cost: f64,                  // æˆæœ¬ç¾å…ƒ                            â”‚
â”‚      pub created_at: String,         // åˆ›å»ºæ—¶é—´                            â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  /// æ’å…¥æ—¥å¿—                                                                 â”‚
â”‚  pub async fn insert_log(db: &Database, log: DbRouterLog) -> Result<()>     â”‚
â”‚                                                                              â”‚
â”‚  /// æŸ¥è¯¢æ—¥å¿—                                                                 â”‚
â”‚  pub async fn query_logs(db: &Database, filter: LogFilter)                  â”‚
â”‚      -> Result<Vec<DbRouterLog>>                                             â”‚
â”‚                                                                              â”‚
â”‚  æ—¥å¿—å†™å…¥æµç¨‹:                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Router å¤„ç†è¯·æ±‚ â”€â”€â–º è®¡ç®—è´¹ç”¨ â”€â”€â–º æ„å»ºæ—¥å¿— â”€â”€â–º å¼‚æ­¥å†™å…¥             â”‚   â”‚
â”‚  â”‚                                         â”‚                           â”‚   â”‚
â”‚  â”‚                                         â–¼                           â”‚   â”‚
â”‚  â”‚                              INSERT INTO router_logs (               â”‚   â”‚
â”‚  â”‚                                request_id, user_id, path,            â”‚   â”‚
â”‚  â”‚                                upstream_id, status_code, latency_ms, â”‚   â”‚
â”‚  â”‚                                prompt_tokens, completion_tokens,     â”‚   â”‚
â”‚  â”‚                                cost, created_at                      â”‚   â”‚
â”‚  â”‚                              ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  ç‰¹ç‚¹:                                                                       â”‚
â”‚  â”œâ”€â”€ å¼‚æ­¥å†™å…¥ï¼Œä¸é˜»å¡è¯·æ±‚                                                   â”‚
â”‚  â”œâ”€â”€ é€šè¿‡ channel å‘é€åˆ°åå°ä»»åŠ¡                                            â”‚
â”‚  â””â”€â”€ æ‰¹é‡å†™å…¥ä¼˜åŒ– (æœªæ¥)                                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§… ä¾èµ–å…³ç³»

```
database-router
â”œâ”€â”€ burncloud-database
â”‚   â””â”€â”€ Database (è¿æ¥æ± )
â”œâ”€â”€ burncloud-common
â”‚   â””â”€â”€ types (Token, Channel, etc.)
â””â”€â”€ external
    â”œâ”€â”€ sqlx            # æ•°æ®åº“è®¿é—®
    â””â”€â”€ serde           # åºåˆ—åŒ–
```
