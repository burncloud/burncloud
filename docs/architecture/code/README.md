# burncloud-code

代码模式模块，提供交互式编程和工具调用功能。

## 🧅 第一层：系统中的位置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          BurnCloud 系统架构                                  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                        🛠️ 辅助工具层                                   │  │
│  │                                                                        │  │
│  │   CLI ─── Download ─── AutoUpdate ─── ★ Code ─── Core ─── Tests       │  │
│  │                                         当前                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

Code 的职责:
├── 交互式 REPL
├── 代码执行
├── 工具调用
├── 安全沙箱
└── AI 辅助编程
```

## 🧅 第二层：Code 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           burncloud-code                                     │
│                          (Code Mode)                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           lib.rs                                       │  │
│  │  • CodeMode                  代码模式管理器                           │  │
│  │  • CodeSession               代码会话                                 │  │
│  │  • ExecutionContext          执行上下文                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           repl.rs                                      │  │
│  │  REPL (交互式解释器)                                                   │  │
│  │  • ReplSession            会话管理                                    │  │
│  │  • execute_code()         执行代码                                    │  │
│  │  • get_output()           获取输出                                    │  │
│  │  • reset()                重置环境                                    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           tools.rs                                     │  │
│  │  工具定义 (Tools)                                                      │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │  │
│  │  │ FileTool    │  │ WebTool     │  │ ShellTool   │                    │  │
│  │  │ • read_file │  │ • fetch_url │  │ • execute   │                    │  │
│  │  │ • write_file│  │ • search    │  │ • run_cmd   │                    │  │
│  │  │ • list_dir  │  │             │  │             │                    │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                    │  │
│  │  ┌─────────────┐  ┌─────────────┐                                     │  │
│  │  │ CodeTool    │  │ AnalysisTool│                                     │  │
│  │  │ • execute   │  │ • lint      │                                     │  │
│  │  │ • evaluate  │  │ • format    │                                     │  │
│  │  └─────────────┘  └─────────────┘                                     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第三层：源码结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              文件结构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  crates/code/                                                                │
│  └── src/                                                                    │
│      ├── lib.rs                     # 模块入口                              │
│      ├── repl.rs                    # REPL 实现                             │
│      └── tools.rs                   # 工具定义                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第四层：交互流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              交互流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

    用户输入 (代码/命令)
             │
             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          CodeMode                                            │
│  1. 解析输入  2. 确定执行类型 (代码/工具调用)  3. 创建执行上下文            │
└─────────────────────────────────────────────────────────────────────────────┘
             │
             ├─────────────────────┐
             │                     │
             ▼                     ▼
┌─────────────────────┐   ┌─────────────────────┐
│    代码执行 (REPL)   │   │    工具调用 (Tools)  │
├─────────────────────┤   ├─────────────────────┤
│ 解析代码 → 安全检查 │   │ 匹配工具 → 参数验证 │
│ → 执行代码 → 捕获输出│   │ → 执行工具 → 返回结果│
└─────────────────────┘   └─────────────────────┘
             │                     │
             └──────────┬──────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          结果处理                                            │
│  { "status": "success", "output": "...", "execution_time": "0.123s" }       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第五层：工具类型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              工具类型                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  文件操作工具 (FileTool)                                                     │
│  read_file(path), write_file(path, content), list_dir(path), delete(path)   │
│                                                                              │
│  网络工具 (WebTool)                                                          │
│  fetch_url(url), search(query), download(url, path)                         │
│                                                                              │
│  Shell 工具 (ShellTool)                                                      │
│  execute(cmd), run_script(script)                                           │
│                                                                              │
│  代码工具 (CodeTool)                                                         │
│  execute(code, lang), evaluate(expr)                                        │
│                                                                              │
│  分析工具 (AnalysisTool)                                                     │
│  lint(code, lang), format(code, lang)                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第六层：安全沙箱

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              安全沙箱                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  沙箱边界                                                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  限制:                                                                 │  │
│  │  • 文件系统访问 - 仅允许指定目录                                      │  │
│  │  • 网络访问    - 仅允许白名单域名                                     │  │
│  │  • 执行时间    - 超时自动终止                                         │  │
│  │  • 内存使用    - 限制最大内存                                         │  │
│  │  • 进程创建    - 限制子进程                                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  执行环境                                                                    │
│  • 独立进程执行                                                              │
│  • cgroup 资源限制 (Linux)                                                  │
│  • seccomp 系统调用过滤                                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第七层：使用场景

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              使用场景                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 代码执行                                                                 │
│     • 运行用户代码片段  • 获取执行结果                                      │
│                                                                              │
│  2. 工具调用                                                                 │
│     • 文件操作  • 网络请求  • 命令执行                                      │
│                                                                              │
│  3. AI 辅助编程                                                              │
│     • 代码生成  • 代码分析  • 自动补全                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 第八层：文件级详解

### src/lib.rs - 模块入口

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           src/lib.rs                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  模块声明:                                                                   │
│  pub mod repl;                                                               │
│  pub mod tools;                                                              │
│                                                                              │
│  核心结构:                                                                   │
│  pub struct CodeMode {                                                       │
│      session: CodeSession,                                                   │
│      context: ExecutionContext,                                              │
│  }                                                                           │
│                                                                              │
│  pub struct CodeSession {                                                    │
│      history: Vec<Interaction>,                                              │
│      state: SessionState,                                                    │
│  }                                                                           │
│                                                                              │
│  pub struct ExecutionContext {                                               │
│      working_dir: PathBuf,                                                   │
│      environment: HashMap<String, String>,                                   │
│      permissions: Permissions,                                               │
│  }                                                                           │
│                                                                              │
│  impl CodeMode {                                                             │
│      pub fn new() -> Self;                                                   │
│      pub async fn execute(&mut self, input: &str) -> Result<Output>;        │
│      pub fn reset(&mut self);                                                │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### src/repl.rs - REPL 实现

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           src/repl.rs                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  pub struct ReplSession {                                                    │
│      state: SessionState,                                                    │
│      output_buffer: String,                                                  │
│  }                                                                           │
│                                                                              │
│  impl ReplSession {                                                          │
│      pub fn new() -> Self;                                                   │
│                                                                              │
│      pub async fn execute_code(&mut self, code: &str) -> Result<Value>;     │
│      // 执行代码                                                            │
│                                                                              │
│      pub fn get_output(&self) -> &str;                                       │
│      // 获取输出                                                            │
│                                                                              │
│      pub fn reset(&mut self);                                                │
│      // 重置环境                                                            │
│  }                                                                           │
│                                                                              │
│  支持的代码类型:                                                             │
│  ├── Rust 表达式                                                             │
│  ├── Shell 命令 (以 ! 开头)                                                  │
│  └── 工具调用 (以 @ 开头)                                                    │
│                                                                              │
│  示例:                                                                       │
│  >>> 1 + 1                                                                   │
│  2                                                                           │
│  >>> !ls -la                                                                 │
│  total 48                                                                    │
│  ...                                                                         │
│  >>> @read_file("src/main.rs")                                               │
│  // 文件内容                                                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### src/tools.rs - 工具定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           src/tools.rs                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  pub trait Tool: Send + Sync {                                               │
│      fn name(&self) -> &str;                                                 │
│      fn description(&self) -> &str;                                          │
│      fn execute(&self, args: Value) -> Result<Value>;                       │
│  }                                                                           │
│                                                                              │
│  // 文件工具                                                                 │
│  pub struct FileTool;                                                        │
│  impl FileTool {                                                             │
│      fn read_file(path: &str) -> Result<String>;                            │
│      fn write_file(path: &str, content: &str) -> Result<()>;               │
│      fn list_dir(path: &str) -> Result<Vec<DirEntry>>;                      │
│      fn delete(path: &str) -> Result<()>;                                   │
│  }                                                                           │
│                                                                              │
│  // 网络工具                                                                 │
│  pub struct WebTool;                                                         │
│  impl WebTool {                                                              │
│      fn fetch_url(url: &str) -> Result<String>;                             │
│      fn search(query: &str) -> Result<Vec<SearchResult>>;                   │
│  }                                                                           │
│                                                                              │
│  // Shell 工具                                                               │
│  pub struct ShellTool;                                                       │
│  impl ShellTool {                                                            │
│      fn execute(cmd: &str) -> Result<Output>;                               │
│      fn run_script(script: &str) -> Result<Output>;                         │
│  }                                                                           │
│                                                                              │
│  // 代码工具                                                                 │
│  pub struct CodeTool;                                                        │
│  impl CodeTool {                                                             │
│      fn execute(code: &str, lang: &str) -> Result<Value>;                   │
│      fn evaluate(expr: &str) -> Result<Value>;                              │
│  }                                                                           │
│                                                                              │
│  // 分析工具                                                                 │
│  pub struct AnalysisTool;                                                    │
│  impl AnalysisTool {                                                         │
│      fn lint(code: &str, lang: &str) -> Result<Vec<LintWarning>>;           │
│      fn format(code: &str, lang: &str) -> Result<String>;                   │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧅 依赖关系

```
burncloud-code
├── burncloud-common        # 共享类型
└── external
    ├── tokio               # 异步运行时
    └── serde               # 序列化
```
