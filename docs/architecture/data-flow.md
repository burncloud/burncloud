# 数据流详解

本文档详细描述 BurnCloud 的请求数据流和组件交互。

## 请求处理流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              请求处理完整流程                                 │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │   Client    │  SDK / Browser / CLI
    │  Request    │  POST /v1/chat/completions
    └──────┬──────┘  Authorization: Bearer sk-xxx
           │
           ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          burncloud-server (Port 3000)                        │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                          axum Router                                   │  │
│  │                                                                        │  │
│  │   路径匹配:                                                            │  │
│  │   - /api/*     → REST API (用户/通道/Token 管理)                       │  │
│  │   - /liveview  → Dioxus LiveView                                      │  │
│  │   - /v1/*      → Fallback to Router (数据平面)                        │  │
│  │   - /_internal → 健康检查、重载配置                                   │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          burncloud-router                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                         proxy_handler                                  │  │
│  │                                                                        │  │
│  │  Step 1: Token 认证                                                    │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ Authorization Header → Bearer Token                             │  │  │
│  │  │                         ↓                                        │  │  │
│  │  │ RouterDatabase::validate_token_and_get_info()                    │  │  │
│  │  │                         ↓                                        │  │  │
│  │  │ 返回: (user_id, group, quota_limit, used_quota)                  │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 2: 配额检查                                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ if used_quota >= quota_limit → 402 Insufficient Quota          │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 3: 限流检查                                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ RateLimiter::check(user_id, 1.0)                                │  │  │
│  │  │ if !passed → 429 Too Many Requests                              │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 4: 模型路由                                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 解析请求体: model = "gpt-4"                                      │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ ModelRouter::route_with_state(group, model, channel_state)      │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 查询 abilities 表: group + model → channel_id                   │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 过滤不可用通道 (熔断、限流、余额不足)                           │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 返回: Channel (包含 base_url, api_key, type, protocol)          │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 5: 熔断器检查                                                    │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ CircuitBreaker::allow_request(channel_id)                       │  │  │
│  │  │ if !passed → 跳过此通道，尝试下一个                             │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 6: 协议适配                                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ DynamicAdaptorFactory::get_adaptor(channel_type, api_version)   │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 检查是否使用透传模式 (Gemini native)                            │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 转换请求格式 (OpenAI → Claude/Gemini/Vertex)                    │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 7: 转发请求                                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 构建目标 URL: base_url + path + query                           │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 设置认证头 (Bearer, x-api-key, x-goog-api-key)                  │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ reqwest::Client::request().send()                               │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 8: 响应处理                                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ Streaming:                                                       │  │  │
│  │  │   - 流式透传响应体                                               │  │  │
│  │  │   - StreamingTokenParser 实时解析 Token                          │  │  │
│  │  │   - 记录 prompt_tokens, completion_tokens                        │  │  │
│  │  │   - 记录 cache_read_tokens, cache_creation_tokens               │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ Non-streaming:                                                   │  │  │
│  │  │   - 读取完整响应                                                 │  │  │
│  │  │   - 转换响应格式 (Claude/Gemini → OpenAI)                       │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 9: 计费计算                                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 获取价格: PriceModel::get(model, currency, region)              │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 检查分段定价: TieredPriceModel::has_tiered_pricing(model)       │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 计费优先级:                                                      │  │  │
│  │  │   1. cache tokens → calculate_cache_cost()                      │  │  │
│  │  │   2. tiered pricing → calculate_tiered_cost_full()              │  │  │
│  │  │   3. priority request → calculate_priority_cost()               │  │  │
│  │  │   4. batch request → calculate_batch_cost()                     │  │  │
│  │  │   5. standard → PriceModel::calculate_cost()                    │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 返回: cost (美元)                                                │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Step 10: 异步日志和扣费                                               │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 构建 DbRouterLog:                                                │  │  │
│  │  │   - request_id, user_id, path                                    │  │  │
│  │  │   - upstream_id, status_code, latency_ms                        │  │  │
│  │  │   - prompt_tokens, completion_tokens, cost                       │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 发送到日志通道: log_tx.send(log)                                │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 后台任务: RouterDatabase::insert_log()                          │  │  │
│  │  │          ↓                                                       │  │  │
│  │  │ 异步扣费: RouterDatabase::deduct_quota()                        │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌─────────────┐
    │   Response  │  返回给客户端
    └─────────────┘
```

## 组件交互图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              组件交互                                        │
└─────────────────────────────────────────────────────────────────────────────┘

                         ┌─────────────────┐
                         │    Request      │
                         └────────┬────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Router AppState                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   client    │ │   config    │ │     db      │ │  balancer   │          │
│  │  (reqwest)  │ │  (Router)   │ │  (Database) │ │ (RoundRobin)│          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   limiter   │ │  circuit_   │ │   model_    │ │  channel_   │          │
│  │  (Rate)     │ │  breaker    │ │  router     │ │  state      │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
│  ┌─────────────┐ ┌─────────────┐                                             │
│  │  adaptor_   │ │  api_       │                                             │
│  │  factory    │ │  detector   │                                             │
│  └─────────────┘ └─────────────┘                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
           ┌──────────────────────┼──────────────────────┐
           │                      │                      │
           ▼                      ▼                      ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  ModelRouter    │    │  AdaptorFactory │    │ ChannelState    │
│                 │    │                 │    │                 │
│ 查询 abilities  │    │ 获取适配器     │    │ 记录状态       │
│ 返回 Channel    │    │ 转换请求/响应  │    │ 更新限流       │
└────────┬────────┘    └────────┬────────┘    └────────┬────────┘
         │                      │                      │
         │                      │                      │
         └──────────────────────┼──────────────────────┘
                                │
                                ▼
                    ┌─────────────────────┐
                    │     Database        │
                    │                     │
                    │  - users           │
                    │  - tokens          │
                    │  - channels        │
                    │  - abilities       │
                    │  - prices          │
                    │  - tiered_pricing  │
                    │  - router_logs     │
                    │  - exchange_rates  │
                    └─────────────────────┘
```

## 计费流程详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              计费流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│ Token 使用统计  │
│                 │
│ prompt_tokens   │────────────┐
│ completion_tok  │────────────┤
│ cache_read_tok  │────────────┤
│ cache_create    │────────────┤
│ audio_tokens    │────────────┘
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          计费优先级判断                                      │
│                                                                              │
│  1. cache_read > 0 || cache_creation > 0 ?                                 │
│     ├── Yes → calculate_cache_cost()                                       │
│     │         (缓存读取 10% 标准，缓存创建 25% 标准)                        │
│     │                                                                       │
│  2. has_tiered_pricing ?                                                    │
│     ├── Yes → calculate_tiered_cost_full()                                 │
│     │         (分段累加，如 Qwen 模型)                                     │
│     │                                                                       │
│  3. is_priority_request ?                                                   │
│     ├── Yes → calculate_priority_cost()                                    │
│     │         (170% 标准价格)                                               │
│     │                                                                       │
│  4. is_batch_request ?                                                      │
│     ├── Yes → calculate_batch_cost()                                       │
│     │         (50% 标准价格)                                                │
│     │                                                                       │
│  5. 默认 → calculate_cost() (标准计费)                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│   扣除配额      │
│                 │
│ 扣除用户余额   │
│ 记录日志       │
└─────────────────┘
```

## 后台任务

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              后台任务                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  价格同步任务 (price_sync)                                                   │
│                                                                              │
│  启动: start_price_sync_task(db, 3600)                                      │
│  间隔: 每小时                                                                │
│  来源: LiteLLM model_prices_and_context_window.json                         │
│                                                                              │
│  同步字段:                                                                   │
│  - input_price, output_price                                                │
│  - cache_read_input_price, cache_creation_input_price                       │
│  - batch_input_price, batch_output_price                                    │
│  - priority_input_price, priority_output_price                              │
│  - audio_input_price                                                        │
│  - context_window, max_output_tokens                                        │
│  - supports_vision, supports_function_calling                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  日志写入任务 (logging)                                                      │
│                                                                              │
│  通道: mpsc::channel::<DbRouterLog>(1000)                                   │
│  操作: RouterDatabase::insert_log()                                         │
│                                                                              │
│  日志字段:                                                                   │
│  - request_id, user_id, path                                                │
│  - upstream_id, status_code, latency_ms                                     │
│  - prompt_tokens, completion_tokens, cost                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  系统监控任务 (monitor)                                                      │
│                                                                              │
│  启动: SystemMonitorService::start_auto_update()                            │
│  采集: CPU, 内存, 磁盘使用率                                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 错误处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              错误处理                                        │
└─────────────────────────────────────────────────────────────────────────────┘

状态码映射:

  401 Unauthorized
  ├── 缺少 Bearer Token
  ├── Token 无效
  └── Token 过期

  402 Payment Required
  └── 配额不足

  404 Not Found
  └── 无匹配的上游

  429 Too Many Requests
  └── 触发限流

  500 Internal Server Error
  └── 数据库/内部错误

  502 Bad Gateway
  └── 所有上游均失败

  503 Service Unavailable
  └── 无可用通道 (熔断/限流)

错误响应格式 (OpenAI 兼容):
{
  "error": {
    "message": "错误描述",
    "type": "error_type",
    "code": "error_code"
  }
}
```
